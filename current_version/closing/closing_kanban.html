<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对账月结任务树形看板原型 - CMMN增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Inter font and set body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 Light Background */
            color: #1f2937; /* Gray-800 Default Text Color */
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8f8f8;
        }

        /* Table-specific styles */
        .tree-table th {
            text-align: left;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            border-bottom: 2px solid #e5e7eb; /* Gray-200 */
            background-color: #f9fafb; /* Gray-50 */
            position: sticky;
            top: 0;
            z-index: 5; /* 确保列表头固定 */
        }
        .tree-table td {
            height: 100%; /* Ensure full height for background color */
        }
        /* Style for Blocked task rows */
        .row-blocked {
            color: #9ca3af !important; /* Gray-400 */
            background-color: #f9fafb;
        }
        .row-blocked:hover {
            background-color: #f3f4f6;
        }

        /* Style for Disabled Discretionary task rows (New) */
        .row-discretionary-disabled {
            color: #b3b3b3 !important; /* Lighter Gray */
            background-color: #fafafa;
            opacity: 0.8;
        }
        .row-discretionary-disabled:hover {
            background-color: #fafafa; /* No hover effect to emphasize disabled state */
        }
        .row-discretionary-disabled .text-gray-700 {
            color: #b3b3b3 !important;
        }
        .row-discretionary-disabled .text-blue-500 {
            color: #b3b3b3 !important;
        }

        /* Unified row highlight style */
        .row-active {
            background-color: #eef2ff !important; /* Indigo-50 */
            border-left: 3px solid #4f46e5; /* Indigo-600 for emphasis */
        }
        /* Revision Phase specific marker */
        .row-revision {
            background-color: #fffbeb !important; /* Amber-50 Light background */
        }

        /* Removed old detail-header-sticky CSS */
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0"></div>

    <div id="app" class="h-full flex flex-col">

        <div id="main-header" class="flex justify-between items-center flex-shrink-0 bg-white border-b border-gray-200 shadow-sm p-4">
            <div>
                <h1 class="text-xl font-bold text-indigo-600">
                    <svg class="w-6 h-6 inline-block mr-2 align-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2m-7 0h2"></path></svg>
                    2025年11月对账月结 - CMMN 案例流概览
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span class="mr-4">发起人: **系统管理员**</span>
                    <span class="mr-4">发起时间: 2025-11-01 10:30:00</span>
                    <span class="mr-4">当前版本: V1</span>
                </p>
            </div>

            <div class="flex space-x-2 flex-shrink-0">
                <button class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition">打印看板</button>
                <button class="px-3 py-1 text-sm font-medium text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50 transition">流程图</button>
                <button class="px-3 py-1 text-sm font-medium text-white bg-amber-500 rounded-md hover:bg-amber-600 transition">撤回流程</button>
                <button class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">终止流程</button>
            </div>
        </div>
        <div class="flex-grow flex custom-scrollbar overflow-hidden">

            <div class="w-full md:w-2/3 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col custom-scrollbar overflow-y-auto">
                <div class="flex-grow overflow-y-auto">
                    <table class="tree-table min-w-full divide-y divide-gray-200">
                        <thead class="sticky top-0">
                            <tr>
                                <th class="w-1/3">计划项/任务名称</th>
                                <th class="w-1/12">责任人</th>
                                <th class="w-1/6">进度</th>
                                <th class="w-1/6">截止日期</th>
                                <th class="w-1/6">依赖</th>
                                <th class="w-1/12 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="plan-flow-table-body" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="task-detail-pane" class="w-full md:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col shadow-lg">

                <div class="flex-shrink-0 p-4 bg-white sticky top-0 z-20 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">计划项详情</h2>

                    <div id="task-detail-task-header" class="pt-2">
                        <p class="text-sm text-gray-500">请从左侧选择一个计划项查看详情。</p>
                    </div>
                    <div class="border-b pt-2"></div>
                </div>
                <div id="task-detail-content-scrollable" class="flex-grow custom-scrollbar overflow-y-auto p-4">
                    <div id="task-detail-content" class="bg-white">
                         <div class="p-10 text-center text-gray-500">
                            <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p>请从左侧表格中选择一个计划项查看详情。</p>
                        </div>
                    </div>
                </div>
                </div>
        </div>
        </div>

    <div id="activation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">激活可选任务</h3>

            <div class="space-y-4">
                <p id="modal-task-name" class="text-lg font-semibold text-indigo-600"></p>
                <input type="hidden" id="modal-phase-id">
                <input type="hidden" id="modal-dtask-id">

                <div>
                    <label for="modal-owner" class="block text-sm font-medium text-gray-700">指定负责人</label>
                    <input type="text" id="modal-owner" value="预算员/部门负责人" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-due-date" class="block text-sm font-medium text-gray-700">截止日期 (可选)</label>
                    <input type="date" id="modal-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-comment-activate" class="block text-sm font-medium text-gray-700">启动备注</label>
                    <textarea id="modal-comment-activate" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="请说明激活此可选任务的原因..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeActivationModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    取消
                </button>
                <button onclick="confirmActivation()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认激活并分配
                </button>
            </div>
        </div>
    </div>

    <div id="approval-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="approval-modal-title">财务初审结果确认</span>
            </h3>

            <p id="approval-modal-task-name" class="text-lg font-semibold text-gray-700 mb-4"></p>
            <input type="hidden" id="approval-modal-task-id">

            <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-md mb-4">
                 <p class="text-sm font-medium text-indigo-700">请选择下一步操作：</p>
                 <p class="text-xs text-indigo-600 mt-1">【确认通过】-> 进入流程下一阶段。 【驳回】-> 退回任务修订。</p>
            </div>

            <div>
                <label for="modal-comment-approval" class="block text-sm font-medium text-gray-700">审批意见/备注 (驳回时必填)</label>
                <textarea id="modal-comment-approval" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="输入审批意见或驳回原因..."></textarea>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeApprovalModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    弹框取消
                </button>
                <button onclick="processApproval('Reject')" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">
                    驳回 (退回修订)
                </button>
                <button onclick="processApproval('Approve')" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认通过
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CMMN Data Model (Updated for Reconciliation Flow) ---
        const kanbanToInboxMap = {
            // Kanban ID -> Inbox Task ID (Sample mapping for 'OpenForm' action)
            203: 4, // 平台结算单对账 (应收)
        };

        let activeNodeId = 203; // Set initial selected node to an active task
        let expandedNodes = new Set([100, 200, 300, 400]);
        let allNodesMap = new Map(); // Flat map for quick lookup

        let stageInstances = {
            200: [{ instance: 1, status: 'Completed', timestamp: 1730419200000, comment: '初次对账完成' }], // 模拟一个已完成的版本
            300: [{ instance: 1, status: 'Pending', timestamp: 1731196800000, comment: '应付对账阶段启动' }]
        };
        let currentInstanceId = 1;


        const budgetPlanTree = [
            // 基础数据准备阶段 (Phase 1)
            { id: 100, name: '基础数据准备', type: 'Phase', progress: 100, owner: 'IT系统', status: 'Completed', children: [
                { id: 101, name: '准备汇率与主数据', type: 'SystemTask', progress: 100, startDate: '2025-11-01', endDate: '2025-11-01', owner: 'IT系统', status: 'Completed' },
                { id: 102, name: '导入ERP交易数据 (自动)', type: 'SystemTask', progress: 100, startDate: '2025-11-01', endDate: '2025-11-01', owner: 'IT系统', status: 'Completed' },
                { id: 104, name: '数据准备完成', type: 'Milestone', progress: 100, startDate: '2025-11-03', endDate: '2025-11-03', owner: 'IT系统', status: 'Completed' }
            ]},

            // 对账与核对阶段 (Phase 2: 应收/平台相关)
            { id: 200, name: '销售模块', type: 'Phase', progress: 75, owner: '应收会计', children: [
                { id: 201, name: '人工确认与补录', type: 'Task', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员A', status: 'Pending', dependencies: [104] },
                { id: 202, name: '自动对账', type: 'SystemTask', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员A', status: 'Pending', dependencies: [201] },
                { id: 203, name: '【有详情】差错报告与调整', type: 'Task', progress: 0, startDate: '2025-11-06', endDate: '2025-11-07', owner: '应收会计', status: 'Blocked', dependencies: [202] },
                { id: 204, name: '生成凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [203] },
                { id: 205, name: '推送凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [204] },
                { id: 206, name: '销售模块完成', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [205] }
            ]},

            // 供应商对账阶段 (Phase 3: 应付相关)
            { id: 300, name: '采购模块', type: 'Phase', progress: 0, owner: '应付会计', children: [
                { id: 301, name: '人工确认与补录', type: 'Task', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员B', status: 'Pending', dependencies: [104] },
                { id: 302, name: '自动对账', type: 'SystemTask', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员B', status: 'Pending', dependencies: [301] },
                { id: 303, name: '差错报告与调整', type: 'Task', progress: 0, startDate: '2025-11-06', endDate: '2025-11-07', owner: '应付会计', status: 'Blocked', dependencies: [302] },
                { id: 304, name: '生成凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [303] },
                { id: 305, name: '推送凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [304] },
                { id: 306, name: '销售模块完成', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [305] }
            ]},

            // 供应商对账阶段 (Phase 4: 应付相关)
            { id: 400, name: '存货模块', type: 'Phase', progress: 0, owner: '存货会计', children: [
                { id: 401, name: '人工确认与补录', type: 'Task', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员C', status: 'Pending', dependencies: [104] },
                { id: 402, name: '自动对账', type: 'SystemTask', progress: 0, startDate: '2025-11-04', endDate: '2025-11-05', owner: '对账员C', status: 'Pending', dependencies: [401] },
                { id: 403, name: '差错报告与调整', type: 'Task', progress: 0, startDate: '2025-11-06', endDate: '2025-11-07', owner: '存货会计', status: 'Blocked', dependencies: [402] },
                { id: 404, name: '生成凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [403] },
                { id: 405, name: '推送凭证', type: 'SystemTask', progress: 0, startDate: '2025-11-08', endDate: '2025-11-08', owner: 'IT系统', status: 'Blocked', dependencies: [404] },
                { id: 406, name: '销售模块完成', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [405] }
            ]},

            // 月结校验 (Phase 5)
            { id: 500, name: '总账核对与终结', type: 'Phase', progress: 0, owner: '财务经理',
                discretionaryTasks: [
                    { id: 901, name: '撰写月结分析报告', owner: '财务经理', type: 'DiscretionaryTask', status: 'Available' },
                    { id: 902, name: '月结会议安排', owner: '行政/秘书', type: 'DiscretionaryTask', status: 'Available' }
                ],
                children: [

                    { id: 502, name: '总账余额自动核对', type: 'SystemTask', progress: 0, startDate: '2025-11-10', endDate: '2025-11-10', owner: 'IT系统', status: 'Pending', dependencies: [206, 306, 406] }, // Note: Assuming the progress '待处理/可执行' means Pending and can be run
                    { id: 503, name: '核对结果人工审批', type: 'Task', progress: 0, startDate: '2025-11-11', endDate: '2025-11-11', owner: '财务经理', status: 'Blocked', dependencies: [502] },
                    { id: 504, name: '对账流程正式完成', type: 'Milestone', progress: 0, startDate: '2025-11-12', endDate: '2025-11-12', owner: '财务经理', status: 'Blocked', dependencies: [503] }
                ]
            }
        ];
        // --- END CMMN Data Model ---

        // --- Core Logic Functions ---
        function calculateAggregateProgress(node) {
            if (!node.children || node.children.length === 0) {
                if (node.type === 'DiscretionaryTask') {
                    return { progress: 0, count: 0, completedCount: 0 };
                }
                node.progress = typeof node.progress === 'number' ? node.progress : 0;
                const leafProgress = getEffectiveStatus(node) === 'Completed' ? 100 : node.progress;
                return {
                    progress: leafProgress,
                    count: 1,
                    completedCount: leafProgress === 100 ? 1 : 0
                };
            }

            let totalProgressSum = 0;
            let totalLeafNodeCount = 0;
            let totalCompletedCount = 0;

            node.children.forEach(child => {
                const result = calculateAggregateProgress(child);
                totalProgressSum += result.progress * result.count;
                totalLeafNodeCount += result.count;
                totalCompletedCount += result.completedCount;
            });

            if (totalLeafNodeCount > 0) {
                node.progress = Math.round(totalProgressSum / totalLeafNodeCount);
                if (totalCompletedCount === totalLeafNodeCount) {
                    node.status = 'Completed';
                } else if (totalCompletedCount > 0) {
                     node.status = 'In Progress';
                } else {
                    node.status = 'Pending';
                }
            } else {
                node.progress = 0;
                if(node.status !== 'Completed') {
                    node.status = 'Draft';
                }
            }

            return {
                progress: node.progress,
                count: totalLeafNodeCount,
                completedCount: totalCompletedCount
            };
        }

        function findNodeById(tree, id) {
            for (const node of tree) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNodeById(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function flattenAndMapNodes(tree) {
            const map = new Map();
            const processNodes = (nodes) => {
                nodes.forEach(node => {
                    map.set(node.id, node);
                    if (node.children) {
                        processNodes(node.children);
                    }
                    if (node.discretionaryTasks) {
                        node.discretionaryTasks.forEach(dTask => {
                            dTask.parentPhaseId = node.id;
                            map.set(dTask.id, dTask);
                        });
                    }
                });
            };
            processNodes(tree);
            return map;
        }

        function getEffectiveStatus(node) {
            if (node.type === 'DiscretionaryTask') {
                const parentPhase = node.parentPhaseId ? allNodesMap.get(node.parentPhaseId) : null;
                if (parentPhase && parentPhase.status === 'Completed') {
                    return 'PhaseClosed';
                }
            }

            if (node.status === 'Completed' || node.status === 'AwaitingRevision') return node.status;

            let isBlockedByDependencies = false;
            if (node.dependencies && node.dependencies.length > 0) {
                isBlockedByDependencies = node.dependencies.some(depId => {
                    const depNode = allNodesMap.get(depId);
                    return depNode && getEffectiveStatus(depNode) !== 'Completed';
                });

                if (isBlockedByDependencies) {
                    return 'Blocked';
                }

                if (node.status === 'Blocked') {
                    return 'Pending';
                }
            }

            if (node.type === 'Milestone' && node.status === 'Blocked' && !isBlockedByDependencies) {
                 return 'Pending';
            }


            return node.status || 'Draft';
        }

        function getStatusTag(status, nodeId = null) {
            let color = 'gray';
            let text = '未开始';
            if (status === 'Completed') {
                color = 'emerald';
                text = '已完成';
            } else if (status === 'Pending' || status === 'Draft' || status === 'In Progress' || status === 'Active') {
                color = 'indigo';
                text = '进行中';
            } else if (status === 'Blocked') {
                color = 'slate';
                text = '待激活';
            } else if (status === 'Available') {
                color = 'blue';
                text = '可选激活';
            } else if (status === 'AwaitingRevision') {
                color = 'amber';
                text = '驳回 (待修订)';
            } else if (status === 'PhaseClosed') {
                color = 'gray';
                text = '阶段已关闭';
            }


            if (nodeId === 200 && status !== 'Completed') {
                const currentInstance = stageInstances[200] ? stageInstances[200].length : 1;
                text = `进行中 (V${currentInstance})`;
                color = 'indigo';
            }
            return `<span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700">${text}</span>`;
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            let bgColor = '';
            if (type === 'error') bgColor = 'bg-red-600';
            else if (type === 'warning') bgColor = 'bg-amber-500';
            else bgColor = 'bg-indigo-600';

            box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0 ${bgColor}`;
            box.innerHTML = message;

            requestAnimationFrame(() => {
                box.classList.remove('translate-x-full', 'opacity-0');
                box.classList.add('translate-x-0', 'opacity-100');
            });

            setTimeout(() => {
                box.classList.remove('translate-x-0', 'opacity-100');
                box.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        }

        function openTaskInInbox(kanbanNodeId) {
            const inboxTaskId = kanbanToInboxMap[kanbanNodeId];
            if (inboxTaskId) {
                showMessage(`正在新标签页中打开待办任务中心，任务 ID: ${inboxTaskId}，并筛选流程为【对账月结】`, 'info');
                const processName = '对账月结';
                const url = `../taskinbox/index.html?taskId=${inboxTaskId}&processFilter=${encodeURIComponent(processName)}`;
                // window.open(url, '_blank');
                window.location.href = url;
            } else {
                showMessage(`节点 ID ${kanbanNodeId} 暂无对应待办任务 (Inbox Task ID)。`, 'warning');
            }
        }
        // --- END Core Logic Functions ---


        // --- NEW: Dropdown Control Functions ---

        /**
         * Toggles the visibility of a task action dropdown menu.
         * Closes all other open dropdowns first.
         * @param {HTMLElement} buttonElement - The button that was clicked.
         */
        function toggleDropdown(buttonElement) {
            event.stopPropagation(); // Stop event from triggering row selection
            const menu = buttonElement.nextElementSibling;
            const isCurrentlyOpen = !menu.classList.contains('hidden');

            // 1. Close all other dropdowns
            document.querySelectorAll('.action-dropdown-menu').forEach(m => {
                if (m !== menu) {
                    m.classList.add('hidden');
                }
            });

            // 2. Toggle the current one
            if (isCurrentlyOpen) {
                menu.classList.add('hidden');
            } else {
                menu.classList.remove('hidden');
            }
        }

        /**
         * Global listener to close all open dropdowns when clicking anywhere outside of them.
         */
        document.addEventListener('click', (event) => {
            const dropdowns = document.querySelectorAll('.action-dropdown-menu');
            dropdowns.forEach(menu => {
                const container = menu.parentElement;
                // Check if the click is outside the container AND the menu is visible
                if (!container.contains(event.target) && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            });
        });

        // --- END NEW Dropdown Control Functions ---

        /**
         * Renders the action menu (Kebab Menu or system action button)
         */
        function renderActionMenu(node, effectiveStatus) {
            if (node.type === 'Phase') return '—';

            // -----------------------------------------------------------------
            // 1. 实现清爽界面逻辑：不可操作状态下隐藏按钮
            // -----------------------------------------------------------------
            // 不可操作状态包括：Completed (已完成), Blocked (待激活/等待依赖), PhaseClosed (阶段已关闭)
            if (effectiveStatus === 'Completed' || effectiveStatus === 'Blocked' || effectiveStatus === 'PhaseClosed') {
                 return '—'; // 隐藏操作按钮
            }
            // AwaitingRevision 状态是需要操作的，因此继续执行后续代码。
            // -----------------------------------------------------------------

            const isSystemTask = node.type === 'SystemTask';
            const isDiscretionary = node.type === 'DiscretionaryTask';
            const isMilestone = node.type === 'Milestone';
            const isAwaitingRevision = effectiveStatus === 'AwaitingRevision';

            if (isSystemTask) {
                // System tasks only have one action: TriggerSystem
                // 此时，Completed/Blocked/PhaseClosed 状态已被过滤，只剩下可执行的系统任务
                return `
                    <button onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'TriggerSystem')" class="px-3 py-1 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 transition">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        ${effectiveStatus === 'AwaitingRevision' ? '重新触发' : '自动执行'}
                    </button>
                `;
            }

            if (isDiscretionary) {
                // Discretionary tasks只有 'Activate' 按钮，仅在 'Available' 状态下显示
                if (effectiveStatus === 'Available') {
                    return `
                        <button onclick="event.stopPropagation(); openActivationModal(${node.parentPhaseId}, ${node.id}, '${node.name}')" class="px-3 py-1 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            激活
                        </button>
                    `;
                }
                return '—'; // 此时应该已经被 STEP 1 过滤了，此处作为安全冗余
            }

            // Milestone:
            if (isMilestone) {
                // 仅在可执行状态下（Pending, Active, AwaitingRevision）显示“完成”按钮
                return `
                    <button onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Complete')" class="px-3 py-1 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        里程碑完成
                    </button>
                `;
            }

            // -----------------------------------------------------------------
            // 2. Standard Task (type: 'Task'): 修复下拉按钮显示问题和颜色
            // -----------------------------------------------------------------
            const isCompleted = effectiveStatus === 'Completed'; // 理论上已被过滤
            const isPendingApproval = false // 假设没有 'PendingApproval' 状态，如果需要可在这里添加逻辑
            const buttonText = isCompleted ? '已完成' : (isPendingApproval ? '进行审批' : '执行操作'); // 此时 buttonText 主要是 '执行操作'

            let customAction = '';

            if (isPendingApproval) {
                customAction = `<a href="#" onclick="event.stopPropagation(); openApprovalModal(${node.id}, '${node.name}')" class="flex items-center px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 font-semibold" role="menuitem" tabindex="-1"> <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 提交审批结果 (必选) </a>`;
            } else {
                 customAction = `<a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Complete')" class="flex items-center px-4 py-2 text-sm text-green-700 hover:bg-green-100 font-semibold" role="menuitem" tabindex="-1"> <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 标记为完成 </a>`;
            }

            // The main button for dropdown (修复：显示“执行操作”文字，并修正颜色)
            return `
                <div class="relative inline-block text-left">
                    <button onclick="toggleDropdown(this)" type="button" class="inline-flex items-center justify-center w-full rounded-md shadow-sm px-2 py-1 bg-indigo-600 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" id="menu-button-${node.id}" aria-expanded="true" aria-haspopup="true">
                        ${buttonText}
                        <svg class="-mr-1 ml-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="action-dropdown-menu hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none z-10" role="menu" aria-orientation="vertical" aria-labelledby="menu-button-${node.id}" tabindex="-1">
                        <div role="none">
                            ${customAction}
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'OpenForm')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                ${isMilestone ? '查看检查点数据' : '进入表单界面'}
                            </a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Assign')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                重新分派责任人
                            </a>
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Comment')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.593 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                打开评论区
                            </a>
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'ViewLog')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                查看流程历史日志
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the single row for a node in the tree table.
         */
        function renderNodeRow(node, level = 0) {
            const effectiveStatus = getEffectiveStatus(node);
            const isPhase = node.type === 'Phase';
            const isMilestone = node.type === 'Milestone';
            const isDiscretionary = node.type === 'DiscretionaryTask';
            const isSystemTask = node.type === 'SystemTask';
            const isCompleted = effectiveStatus === 'Completed';
            const isBlocked = effectiveStatus === 'Blocked';
            const isPhaseClosed = effectiveStatus === 'PhaseClosed';
            const isExpanded = expandedNodes.has(node.id);
            const isRevision = effectiveStatus === 'AwaitingRevision'; // 使用 effectiveStatus 判断

            let rowClass = `cursor-pointer hover:bg-gray-50 ${node.id === activeNodeId ? 'row-active' : ''}`;
            if (isBlocked) {
                rowClass += ' row-blocked';
            } else if (isRevision) {
                rowClass += ' row-revision';
            } else if (isDiscretionary && isPhaseClosed) {
                rowClass += ' row-discretionary-disabled';
            }
            // 确保被选中的行始终具有高亮样式，并覆盖其他颜色。
            if (node.id === activeNodeId) {
                 rowClass = 'row-active'; // 选中时，强制使用 row-active 样式
            }

            const dependenciesHtml = node.dependencies && node.dependencies.length > 0
                ? node.dependencies.map(depId => {
                    const depNode = allNodesMap.get(depId);
                    const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                    const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : 'text-slate-600';
                    const statusText = depStatus === 'Completed' ? '已达成' : '等待前置';
                    return `<button onclick="event.stopPropagation(); selectPlanNode(${depId})" class="text-xs hover:underline text-left block"><span class="font-medium text-gray-700">${depNode ? depNode.name : `ID:${depId}`}</span> <span class="${statusColor} ml-2 font-medium">${statusText}</span></button>`;
                }).join('')
                : '无依赖';

            const nameTextColor = isCompleted ? 'text-gray-400' : 'text-gray-700';

            let typeIcon = '';
            if (isPhase) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`;
            } else if (isMilestone) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (isRevision) {
                 typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.394 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            } else if (isDiscretionary) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (isSystemTask) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-1.756.426-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
            } else {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 ${nameTextColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M10 12h.01"></path></svg>`;
            }

            let html = `<tr data-node-id="${node.id}" class="${rowClass}" onclick="selectPlanNode(${node.id})">`;

            html += `<td class="py-3 px-4 text-sm font-medium whitespace-nowrap ${nameTextColor}">`;
            html += `<div style="padding-left: ${level * 1.5}rem;" class="flex items-center">`;
            if (isPhase) {
                html += `<span onclick="event.stopPropagation(); toggleExpand(${node.id})" class="mr-2 text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4 inline-block transform ${isExpanded ? 'rotate-90' : 'rotate-0'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                         </span>`;
            } else {
                html += `<span style="width: 1.5rem;"></span>`;
            }
            html += `${typeIcon} ${node.name}`;
            html += `</div></td>`;

            html += `<td class="py-3 px-4 text-sm whitespace-nowrap text-gray-600">${node.owner || '待定'}</td>`;

            html += `<td class="py-3 px-4 text-sm w-32">`;

            if (isDiscretionary && isPhaseClosed) {
                html += `<div class="mt-1">${getStatusTag('PhaseClosed', node.id)}</div>`;
            } else if (isDiscretionary) {
                 html += `<div class="mt-1">${getStatusTag(effectiveStatus, node.id)}</div>`;
            } else {
                html += `<div class="flex items-center space-x-2">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                ${isMilestone ? `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-purple-500' : 'bg-gray-200'}" style="width: ${isCompleted ? 100 : 0}%"></div>
                                ` : `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                                `}
                            </div>
                            <span class="text-xs font-medium text-gray-700 w-8 text-right">${node.progress || 0}%</span>
                        </div>
                        <div class="mt-1">${getStatusTag(effectiveStatus, node.id)}</div>
                        `;
            }
            html += `</td>`;

            const today = new Date().setHours(0, 0, 0, 0);
            const dueDate = node.endDate ? new Date(node.endDate).setHours(0, 0, 0, 0) : null;
            const isOverdue = !isCompleted && dueDate && dueDate < today;
            html += `<td class="py-3 px-4 text-sm whitespace-nowrap ${isOverdue ? 'text-red-600 font-semibold' : nameTextColor}">${node.endDate || '—'}</td>`;

            html += `<td class="py-3 px-4 text-sm whitespace-normal text-gray-600 w-40">${dependenciesHtml}</td>`;

            html += `<td class="py-3 px-4 text-center text-sm whitespace-nowrap">${renderActionMenu(node, effectiveStatus)}</td>`;

            html += `</tr>`;

            if (isPhase && isExpanded && node.children) {
                node.children.forEach(child => {
                    html += renderNodeRow(child, level + 1);
                });
            }

            if (isPhase && isExpanded && node.discretionaryTasks && node.discretionaryTasks.length > 0) {
                 node.discretionaryTasks.forEach(dTask => {
                     html += renderNodeRow(dTask, level + 1);
                 });
             }

            return html;
        }

        /**
         * Selects a node, updates the activeNodeId, and re-renders the Kanban tree.
         */
        function selectPlanNode(nodeId) {
            if (activeNodeId === nodeId) {
                 // activeNodeId = null; // Don't allow de-selection
            } else {
                activeNodeId = nodeId;
            }
            updateAndRenderTree();
        }

        /**
         * Handles the execution of a specific task action.
         */
        function handleTaskAction(taskId, actionType) {
            const node = allNodesMap.get(taskId);
            if (!node) return;

            // Simple state transition logic for demonstration
            let actionText = '';
            switch (actionType) {
                case 'Complete':
                    if (node.type === 'Milestone') {
                        node.status = 'Completed';
                        node.progress = 100;
                        showMessage(`里程碑 [${node.name}] 已标记为完成。`, 'success');
                    } else {
                        node.status = 'Completed';
                        node.progress = 100;
                        showMessage(`任务 [${node.name}] 已标记为完成。`, 'success');
                    }
                    break;
                case 'TriggerSystem':
                    node.status = 'Completed';
                    node.progress = 100;
                    showMessage(`系统任务 [${node.name}] 已被手动执行并完成。`, 'success');
                    break;
                case 'OpenForm':
                    const inboxId = kanbanToInboxMap[taskId];
                    if (inboxId) {
                        openTaskInInbox(taskId);
                        return;
                    }
                    actionText = node.type === 'Milestone' ? '查看检查点数据' : '进入表单界面';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'Assign':
                    actionText = '重新分派责任人';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'Comment':
                    actionText = '打开评论区';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'ViewLog':
                    actionText = '查看流程历史日志';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                default:
                    actionText = '执行未知操作';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
            }

            // Close all dropdown menus
            document.querySelectorAll('.action-dropdown-menu').forEach(d => d.classList.add('hidden'));

            updateAndRenderTree();
        }


        // --- Modals ---

        function openActivationModal(phaseId, dtaskId, taskName) {
            document.getElementById('modal-title').textContent = '激活可选任务';
            document.getElementById('modal-task-name').textContent = `即将激活: ${taskName}`;
            document.getElementById('modal-phase-id').value = phaseId;
            document.getElementById('modal-dtask-id').value = dtaskId;
            document.getElementById('activation-modal').classList.remove('hidden');
        }

        function closeActivationModal() {
            document.getElementById('activation-modal').classList.add('hidden');
        }

        function confirmActivation() {
            const phaseId = parseInt(document.getElementById('modal-phase-id').value);
            const dtaskId = parseInt(document.getElementById('modal-dtask-id').value);
            const owner = document.getElementById('modal-owner').value;
            const dueDate = document.getElementById('modal-due-date').value;
            const comment = document.getElementById('modal-comment-activate').value;

            closeActivationModal();

            const dTaskNode = allNodesMap.get(dtaskId);
            if (!dTaskNode) return;

            // 模拟激活
            dTaskNode.status = 'Pending';
            dTaskNode.owner = owner;
            dTaskNode.endDate = dueDate || '—';

            showMessage(`可选任务 [${dTaskNode.name}] 已成功激活并分配给 ${owner}。`, 'success');
            updateAndRenderTree();
        }

        function openApprovalModal(taskId, taskName) {
            document.getElementById('approval-modal-task-name').textContent = `任务: ${taskName}`;
            document.getElementById('approval-modal-task-id').value = taskId;
            document.getElementById('approval-modal').classList.remove('hidden');
        }

        function closeApprovalModal() {
             document.getElementById('approval-modal').classList.add('hidden');
        }


        function processApproval(result) {
            const taskId = parseInt(document.getElementById('approval-modal-task-id').value);
            const comment = document.getElementById('modal-comment-approval').value;

            closeApprovalModal();

            const node = allNodesMap.get(taskId);
            if (!node) return;

            // 模拟任务完成（即审批任务已执行完毕）
            node.status = 'Completed';
            node.progress = 100;

            if (result === 'Approve') {
                // 模拟激活下一阶段或后续任务（这里假设批准直接完成后续的检查点）
                const milestone504 = allNodesMap.get(504);
                 if (milestone504) {
                     milestone504.status = 'Pending'; // 允许自动触发或手动完成
                     showMessage('审批通过，流程已推进至【对账流程正式完成】里程碑。', 'success');
                 } else {
                     showMessage('审批通过。', 'success');
                 }

            } else if (result === 'Reject') {
                 // 模拟驳回，退回给前一阶段的主要任务进行修订
                 const phaseId = 400; // 假设退回到存货模块阶段
                 const task403 = allNodesMap.get(403);
                 if (task403) {
                     // 流程实例版本提升
                     currentInstanceId++;
                     const phaseToReset = allNodesMap.get(phaseId);

                     if (!stageInstances[phaseId]) {
                         stageInstances[phaseId] = [];
                     }
                     // 记录历史
                     stageInstances[phaseId].push({ instance: currentInstanceId, status: 'AwaitingRevision', timestamp: Date.now(), comment: `审批驳回，需重新修订。意见: ${comment}` });
                     phaseToReset.status = 'AwaitingRevision'; // 阶段标记为修订
                     task403.status = 'AwaitingRevision'; // 关键任务标记为修订

                     // 重置后续任务/里程碑
                     [404, 405, 406, 502, 503].forEach(id => {
                        const n = allNodesMap.get(id);
                        if (n) { n.status = 'Blocked'; n.progress = 0; }
                     });

                     showMessage(`审批驳回，任务 [${task403.name}] 已退回至待修订状态 (V${currentInstanceId})。意见: ${comment}`, 'warning');

                 } else {
                     showMessage(`驳回操作执行，但无法找到目标修订任务。`, 'error');
                 }

            }
            updateAndRenderTree();
        }

        // --- View/Render ---

        /**
         * Re-renders the entire tree structure after a data change.
         */
        function updateAndRenderTree() {
            // 1. Calculate progress and flatten nodes
            calculateAggregateProgress({ children: budgetPlanTree });
            allNodesMap = flattenAndMapNodes(budgetPlanTree);

            // 2. Render table rows
            const tableBody = document.getElementById('plan-flow-table-body');
            let html = budgetPlanTree.map(node => renderNodeRow(node)).join('');
            tableBody.innerHTML = html;

            // 3. Render Detail Pane
            renderDetailPane(activeNodeId);
        }

        /**
         * Renders the detail pane for the currently selected node.
         */
        function renderDetailPane(nodeId) {
            const node = allNodesMap.get(nodeId);
            const detailTaskHeader = document.getElementById('task-detail-task-header');
            const detailContent = document.getElementById('task-detail-content');

            if (!node) {
                 detailTaskHeader.innerHTML = `<p class="text-sm text-gray-500">请从左侧选择一个计划项查看详情。</p>`;
                 detailContent.innerHTML = `<div class="p-10 text-center text-gray-500">
                            <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p>请从左侧表格中选择一个计划项查看详情。</p>
                        </div>`;
                 return;
            }

            const effectiveStatus = getEffectiveStatus(node);
            const isCompleted = effectiveStatus === 'Completed';
            const isDiscretionaryAndClosed = node.type === 'DiscretionaryTask' && effectiveStatus === 'PhaseClosed';

            // --- 1. Render Header (with Action Button) ---
            const actionButtonHtml = renderActionMenu(node, effectiveStatus);
            const nodeTypeText = node.type === 'Phase' ? '阶段' : (node.type === 'Milestone' ? '里程碑' : (node.type === 'SystemTask' ? '系统任务' : (node.type === 'DiscretionaryTask' ? '可选任务' : '常规任务')));

            let taskHeaderHtml = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-2xl font-bold ${isCompleted ? 'text-emerald-600' : (isDiscretionaryAndClosed ? 'text-gray-400' : 'text-indigo-600')}">${node.name}</h3>
                    <div class="flex-shrink-0">
                        ${actionButtonHtml}
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    ${getStatusTag(effectiveStatus, node.id)}
                    <span class="text-sm text-gray-500">${nodeTypeText}</span>
                </div>
            `;
            detailTaskHeader.innerHTML = taskHeaderHtml;

            // --- 2. Render Detail Content (Scrollable Part) ---
            const dependenciesHtmlContent = node.dependencies && node.dependencies.length > 0 ? node.dependencies.map(depId => {
                const depNode = allNodesMap.get(depId);
                const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : 'text-slate-600';
                const statusText = depStatus === 'Completed' ? '已达成' : '等待前置';
                return `<div class="flex justify-between text-sm text-gray-700"><span>${depNode ? depNode.name : `ID:${depId}`}</span><span class="${statusColor} font-medium">${statusText}</span></div>`;
            }).join('') : '<p class="text-sm text-gray-500">无前置依赖项。</p>';

            let commonDetails = `
                <h4 class="font-semibold text-gray-700 mb-2">基本信息</h4>
                <p class="text-gray-700"><strong>节点类型:</strong> ${nodeTypeText} (${node.type})</p>
                <p class="text-gray-700"><strong>责任人:</strong> ${node.owner}</p>
                <p class="text-gray-700"><strong>计划时间:</strong> ${node.startDate || '—'} - ${node.endDate || '—'}</p>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-600 font-medium mb-2 border-b pb-1">前置依赖项:</p>
                    ${dependenciesHtmlContent}
                </div>
            `;

            let detailHtml = '';
            if (node.type === 'Phase') {
                const totalTasks = node.children.length;
                const completedTasks = node.children.filter(c => getEffectiveStatus(c) === 'Completed').length;
                let discretionaryHtml = '';

                if (node.discretionaryTasks) {
                    discretionaryHtml = node.discretionaryTasks.map(dTask => {
                        const dStatus = getEffectiveStatus(dTask);
                        const dStatusTag = getStatusTag(dStatus, dTask.id);
                        const actionButton = (dStatus === 'Available') ? `<button onclick="event.stopPropagation(); openActivationModal(${node.id}, ${dTask.id}, '${dTask.name}')" class="px-2 py-0.5 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">激活</button>` : '—';
                        return `
                             <li class="flex justify-between items-center py-2 border-b last:border-b-0">
                                 <div class="flex items-center space-x-3">
                                     <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                     <span class="text-sm text-gray-700">${dTask.name}</span>
                                     ${dStatusTag}
                                 </div>
                                 <div class="flex-shrink-0">${actionButton}</div>
                             </li>
                        `;
                    }).join('');
                }

                const historyHtml = stageInstances[node.id] ? stageInstances[node.id].map(instance => `
                    <div class="p-3 border rounded-lg ${instance.status === 'Completed' ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}">
                        <p class="text-sm font-semibold text-gray-800">版本 V${instance.instance} - ${instance.status === 'Completed' ? '流程完成' : '退回修订'}</p>
                        <p class="text-xs text-gray-600">时间: ${new Date(instance.timestamp).toLocaleString('zh-CN', { hour12: false })}</p>
                        <p class="text-sm mt-1">${instance.comment}</p>
                    </div>
                `).join('') : '';


                detailHtml = `
                    <h4 class="font-semibold text-gray-700 mb-2">阶段进度</h4>
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-3">
                             <div class="h-3 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                        </div>
                        <span class="text-lg font-bold text-gray-700 w-12 text-right">${node.progress || 0}%</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">${completedTasks} / ${totalTasks} 个关键项已完成。</p>

                    <div class="mb-6 border-b pb-4">
                        ${commonDetails}
                    </div>

                    ${(node.discretionaryTasks && node.discretionaryTasks.length > 0) ? `
                        <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">可选任务列表</h4>
                        <ul class="bg-white border rounded-lg p-3">
                            ${discretionaryHtml}
                        </ul>
                    ` : ''}

                    <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">版本历史</h4>
                    <div class="space-y-2">
                        ${historyHtml || '<p class="text-sm text-gray-500">无历史版本记录。</p>'}
                    </div>
                `;

            } else {
                // Task/Milestone/SystemTask/DTask logic
                detailHtml = `
                    ${isDiscretionaryAndClosed ? `
                        <div class="bg-gray-100 text-gray-600 p-3 rounded-lg flex items-start mb-4">
                            <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="text-sm">此可选任务所属的阶段已完成，当前任务已禁用。</p>
                        </div>
                    ` : ''}
                    ${node.status === 'AwaitingRevision' ? `
                        <div class="bg-amber-100 text-amber-700 p-3 rounded-lg flex items-start mb-4">
                            <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.394 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <p class="text-sm">此任务已被**驳回**，请在执行操作中选择【进入表单界面】进行修订和重新提交。</p>
                        </div>
                    ` : ''}
                    ${node.type !== 'Milestone' ? `
                        <h4 class="font-semibold text-gray-700 mb-2">任务进度</h4>
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                 <div class="h-3 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                            </div>
                            <span class="text-lg font-bold text-gray-700 w-12 text-right">${node.progress || 0}%</span>
                        </div>
                    ` : ''}
                    <div class="mb-6">
                        ${commonDetails}
                    </div>

                    <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">附加说明</h4>
                    <p class="text-sm text-gray-600">这是一个 ${node.type} 节点，代表财务月结流程中的一个具体工作项。在实际系统中，这里将展示详细的任务内容、附件、工作记录等。</p>
                `;
            }

            detailContent.innerHTML = detailHtml;
            // Scroll to top of the content area
            document.getElementById('task-detail-content-scrollable').scrollTop = 0;
        }

        /**
         * Toggles the expansion state of a Phase node.
         */
        function toggleExpand(nodeId) {
            event.stopPropagation();
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            updateAndRenderTree();
        }


        // 4. 初始加载逻辑
        document.addEventListener('DOMContentLoaded', () => {
            updateAndRenderTree();
        });
    </script>
</body>
</html>
