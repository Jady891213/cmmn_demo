<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>财务对账任务中心 - 标准版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 状态胶囊样式 (标准椭圆) */
        .module-pill {
            padding: 2px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            border-radius: 9999px;
            cursor: default;
            transition: all 0.2s;
            white-space: nowrap;
            border: 1px solid transparent;
        }
        .module-pill:hover { opacity: 0.9; transform: translateY(-1px); }

        /* 三种标准状态颜色 */
        .status-completed { background-color: #d1fae5; color: #047857; border-color: #a7f3d0; } /* Green */
        .status-active { background-color: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; } /* Blue */
        .status-pending { background-color: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; } /* Gray */

        /* 热力图样式 */
        .matrix-cell { transition: all 0.2s; }
        .matrix-cell:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; }

        /* 通用悬浮卡片 */
        #hover-card { pointer-events: none; transition: opacity 0.15s; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-30">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-1.5 rounded">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">对账任务管理平台</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-wider">Task Management Center</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
             <div class="text-right">
                <p class="text-sm font-medium text-gray-900">管理员</p>
                <p class="text-xs text-gray-500">财务部</p>
            </div>
            <div class="h-8 w-8 bg-gray-100 text-gray-600 rounded flex items-center justify-center text-sm font-bold">A</div>
        </div>
    </nav>

    <div class="bg-gray-50 border-b border-gray-200 px-6 py-3 flex items-center gap-4 shadow-inner z-20">

        <div class="bg-gray-200 p-1 rounded flex items-center text-xs font-medium">
            <button onclick="switchView('period')" id="btn-period" class="view-btn px-3 py-1.5 rounded bg-white text-gray-800 shadow-sm transition-all">月度视图</button>
            <button onclick="switchView('entity')" id="btn-entity" class="view-btn px-3 py-1.5 rounded text-gray-500 hover:text-gray-700 transition-all">公司视图</button>
            <button onclick="switchView('matrix')" id="btn-matrix" class="view-btn px-3 py-1.5 rounded text-gray-500 hover:text-gray-700 transition-all flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                全局概览
            </button>
        </div>

        <div class="h-6 w-px bg-gray-300 mx-2"></div>

        <div class="flex items-center gap-3 transition-all duration-300" id="filter-area">
            <div class="flex items-center gap-2">
                <label class="text-xs font-bold text-gray-500 uppercase">年份:</label>
                <select id="select-year" class="block w-24 pl-2 pr-6 py-1 text-sm border-gray-300 rounded border shadow-sm focus:ring-blue-500" onchange="refreshData()">
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>

            <div id="filter-month" class="flex items-center gap-2">
                <label class="text-xs font-bold text-gray-500 uppercase">期间:</label>
                <select id="select-month" class="block w-32 pl-2 pr-6 py-1 text-sm border-gray-300 rounded border shadow-sm focus:ring-blue-500" onchange="refreshData()">
                    <option value="11" selected>11月</option>
                    <option value="10">10月</option>
                </select>
            </div>

            <div id="filter-company" class="flex items-center gap-2 hidden">
                <label class="text-xs font-bold text-gray-500 uppercase">公司主体:</label>
                <select id="select-company" class="block w-48 pl-2 pr-6 py-1 text-sm border-gray-300 rounded border shadow-sm focus:ring-blue-500" onchange="refreshData()">
                    <option value="US_AMZ" selected>Amazon US - 北美</option>
                    <option value="DE_AMZ">Amazon DE - 德国</option>
                    <option value="UK_SHOP">Shopify UK - 独立站</option>
                </select>
            </div>
        </div>

        <div class="flex-grow"></div>

        <button onclick="openStartModal()" class="group px-4 py-1.5 text-sm font-bold text-white bg-blue-600 rounded hover:bg-blue-700 shadow-sm flex items-center transition border border-blue-700">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            新建任务 (Create)
        </button>
    </div>

    <div class="flex-grow p-6 overflow-y-auto bg-gray-100 relative">
        <div class="max-w-[98%] mx-auto">

            <div id="stats-bar" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 fade-in">
                </div>

            <div class="bg-white rounded shadow-sm border border-gray-200 fade-in relative min-h-[400px]">

                <div id="list-header" class="px-6 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <h2 id="table-title" class="text-sm font-bold text-gray-700 uppercase tracking-wide">任务列表</h2>
                    <div class="flex gap-4 text-[10px] text-gray-500 items-center">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> 已完成</span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-1"></span> 进行中</span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-gray-300 rounded-full mr-1"></span> 未开始</span>
                        </div>
                    </div>
                </div>

                <table id="main-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="table-thead-tr">
                            </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200 text-sm">
                        </tbody>
                </table>

                <div id="matrix-container" class="hidden overflow-x-auto pb-4">
                    <table class="min-w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="p-3 border-b border-r border-gray-200 bg-gray-100 text-left text-xs font-bold text-gray-500 uppercase sticky left-0 z-20 w-48">公司 / 期间</th>
                                </tr>
                        </thead>
                        <tbody id="matrix-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="open-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md transform transition-all scale-95" id="modal-panel">

            <div class="bg-gray-50 px-6 py-4 rounded-t-lg flex justify-between items-center border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800">新建任务</h3>
                <button onclick="closeStartModal()" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
            </div>

            <div class="p-6 space-y-5">

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">任务期间 (Period)</label>
                    <div class="flex gap-2">
                        <select class="block w-1/3 border-gray-300 rounded shadow-sm text-sm bg-gray-50">
                            <option>2025</option>
                        </select>
                        <select class="block w-2/3 border-gray-300 rounded shadow-sm text-sm font-medium text-gray-900">
                            <option>11月</option>
                            <option>12月</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">公司主体 (Entities)</label>
                    <select class="block w-full border-gray-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" multiple size="5">
                        <option selected>Amazon US - 北美</option>
                        <option selected>Amazon DE - 德国</option>
                        <option>Shopify UK - 独立站</option>
                        <option>Rakuten JP - 日本</option>
                    </select>
                    <p class="text-[10px] text-gray-400 mt-1">* 按住 Ctrl/Cmd 可多选。创建后将自动生成相关里程碑。</p>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-end gap-3 border-t border-gray-200">
                <button onclick="closeStartModal()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50">取消</button>
                <button onclick="closeStartModal(); alert('任务已创建，配置的流程引擎已启动。')" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 shadow-sm">
                    确认创建
                </button>
            </div>
        </div>
    </div>

    <div id="hover-card" class="fixed hidden bg-white border border-gray-200 p-4 rounded-lg shadow-xl z-50 w-56">
        <div class="flex justify-between items-start mb-2 border-b pb-2">
            <h4 id="card-title" class="font-bold text-gray-800">Title</h4>
            <span id="card-badge" class="px-2 py-0.5 text-xs rounded-full">Status</span>
        </div>
        <div class="space-y-2 text-sm text-gray-600">
            <div class="flex justify-between"><span>当前阶段:</span> <span class="font-medium text-gray-900" id="card-phase">--</span></div>
            <div class="flex justify-between"><span>完成度:</span> <span class="font-medium text-gray-900" id="card-progress">--</span></div>
            <div class="mt-2 pt-2 border-t text-xs text-gray-400">点击查看详情 &rarr;</div>
        </div>
    </div>

    <script>
        // --- 模拟数据 ---
        // 状态仅包含: completed (已完成), active (进行中), pending (未开始)
        const stores = [
            { id: 'US_AMZ', name: 'Amazon US', modules: { S: 'completed', P: 'completed', I: 'active' } },
            { id: 'DE_AMZ', name: 'Amazon DE', modules: { S: 'active', P: 'pending', I: 'pending' } },
            { id: 'UK_SHOP', name: 'Shopify UK', modules: { S: 'completed', P: 'completed', I: 'completed' } },
            { id: 'JP_RAK', name: 'Rakuten JP', modules: { S: 'pending', P: 'pending', I: 'pending' } }
        ];

        const months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

        let fullData = [];
        stores.forEach(store => {
            months.forEach(m => {
                let status = 'completed';
                let progress = 100;
                let modules = { S: 'completed', P: 'completed', I: 'completed' };
                let phase = '流程结束';

                if (m === 11) {
                    // 当前月
                    modules = store.modules;
                    if (store.id === 'US_AMZ') { status = 'active'; progress = 85; phase = '存货核对'; }
                    else if (store.id === 'DE_AMZ') { status = 'active'; progress = 20; phase = '销售核对'; }
                    else if (store.id === 'UK_SHOP') { status = 'completed'; progress = 100; phase = '流程结束'; }
                    else { status = 'pending'; progress = 0; phase = '待启动'; }
                } else if (m > 11) {
                    status = 'pending'; progress = 0; modules = { S: 'pending', P: 'pending', I: 'pending' }; phase = '未开始';
                }

                fullData.push({
                    id: `${store.id}-${m}`,
                    entityId: store.id,
                    entityName: store.name,
                    year: 2025,
                    month: m,
                    period: `2025-${String(m).padStart(2, '0')}`,
                    status: status,
                    progress: progress,
                    modules: modules,
                    phase: phase
                });
            });
        });

        let currentView = 'period';

        // --- 核心逻辑 ---
        function renderContent() {
            if (currentView === 'matrix') renderMatrix();
            else {
                renderListTable();
                renderStats();
            }
        }

        function renderListTable() {
            const thead = document.getElementById('table-thead-tr');
            const tbody = document.getElementById('table-body');
            const year = document.getElementById('select-year').value;

            tbody.innerHTML = '';

            // 1. 确定第一列标题 & 数据源
            let col1Title = '';
            let data = [];

            if (currentView === 'period') {
                col1Title = '公司名称';
                const month = parseInt(document.getElementById('select-month').value);
                data = fullData.filter(d => d.year == year && d.month == month);
            } else {
                col1Title = '期间';
                const entityId = document.getElementById('select-company').value;
                data = fullData.filter(d => d.year == year && d.entityId == entityId).sort((a,b) => b.month - a.month);
            }

            // 2. 表头 (通用)
            thead.innerHTML = `
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase w-1/4">${col1Title}</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">里程碑 (Milestones)</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">任务状态</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">总体进度</th>
                <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th>
            `;

            // 3. 渲染行
            data.forEach(item => {
                // 第一列
                let col1Content = '';
                if (currentView === 'period') {
                    col1Content = `<div class="font-medium text-gray-900">${item.entityName}</div>`;
                } else {
                    col1Content = `<span class="font-bold text-gray-800">${item.period}</span>`;
                }

                // 里程碑 (Pills) - 增加 title 属性作为原生悬停提示
                const moduleHtml = `
                    <div class="flex gap-2">
                        ${getModuleBadge('销售', item.modules.S)}
                        ${getModuleBadge('采购', item.modules.P)}
                        ${getModuleBadge('存货', item.modules.I)}
                    </div>
                `;

                let statusObj = getOverallStatus(item.status);

                // <<<<<<<<<<<<<<< 列表视图跳转修复点 1：将 onclick 绑定到 <tr> 上 >>>>>>>>>>>>>>>
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition cursor-pointer border-b border-gray-100" onclick="window.location.href='closing_kanban.html?entity=${item.entityId}&period=${item.period}'">
                        <td class="px-6 py-4 whitespace-nowrap">${col1Content}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${moduleHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs font-bold ${statusObj.bg} ${statusObj.text}">${statusObj.label}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="text-xs font-medium text-gray-600 mr-2 w-8 text-right">${item.progress}%</span>
                                <div class="w-24 bg-gray-200 rounded-full h-1.5">
                                    <div class="${statusObj.barColor} h-1.5 rounded-full" style="width: ${item.progress}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-blue-600 hover:underline text-xs font-bold">查看详情 &rarr;</td>
                    </tr>
                `;
            });
        }

        // 生成胶囊，增加 title 属性用于悬停显示状态文案
        function getModuleBadge(label, status) {
            let cls = 'status-pending';
            let statusText = '未开始';

            if (status === 'completed') { cls = 'status-completed'; statusText = '已完成'; }
            else if (status === 'active') { cls = 'status-active'; statusText = '进行中'; }
            else { cls = 'status-pending'; statusText = '未开始'; }

            // 鼠标悬停显示： "销售: 已完成"
            return `<div class="module-pill ${cls}" title="${label}: ${statusText}">${label}</div>`;
        }

        function getOverallStatus(status) {
            if (status === 'completed') return { bg: 'bg-green-100', text: 'text-green-800', label: '已完成', barColor: 'bg-green-500' };
            if (status === 'active') return { bg: 'bg-blue-100', text: 'text-blue-800', label: '进行中', barColor: 'bg-blue-500' };
            return { bg: 'bg-gray-100', text: 'text-gray-500', label: '未开始', barColor: 'bg-gray-300' };
        }

        function renderMatrix() {
            const tbody = document.getElementById('matrix-body');
            const theadRow = document.querySelector('#matrix-container thead tr');
            const year = document.getElementById('select-year').value;

            let headerHtml = '<th class="p-3 border-b border-r border-gray-200 bg-gray-100 text-left text-xs font-bold text-gray-500 uppercase sticky left-0 z-20 w-48 shadow-sm">公司名称</th>';
            months.forEach(m => {
                const isCurrent = (m === 11 && year == 2025);
                headerHtml += `<th class="p-3 border-b border-gray-200 text-center text-xs font-bold text-gray-500 uppercase w-16 ${isCurrent ? 'bg-blue-50 text-blue-700' : 'bg-gray-50'}">${m}月</th>`;
            });
            theadRow.innerHTML = headerHtml;

            tbody.innerHTML = '';
            const uniqueStores = [...new Map(fullData.map(item => [item.entityId, item])).values()];

            uniqueStores.forEach(store => {
                let rowHtml = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100">
                        <td class="p-3 border-r border-gray-200 bg-white font-medium text-sm text-gray-700 sticky left-0 z-10 shadow-sm">
                            <div class="truncate w-40" title="${store.entityName}">${store.entityName}</div>
                        </td>
                `;
                months.forEach(m => {
                    const record = fullData.find(d => d.entityId === store.entityId && d.year == year && d.month === m);
                    let bg = 'bg-gray-200';
                    let text = '';
                    if (record) {
                        if (record.status === 'completed') { bg = 'bg-green-400 hover:bg-green-500'; text = '✓'; }
                        else if (record.status === 'active') { bg = 'bg-blue-400 hover:bg-blue-500'; text = record.progress+'%'; }
                    }
                    // <<<<<<<<<<<<<<< 矩阵视图跳转修复点 2：将 onclick 绑定到色块 <div> 上 >>>>>>>>>>>>>>>
                    rowHtml += `<td class="p-2 text-center h-12">
                        <div class="w-full h-8 rounded matrix-cell ${bg} flex items-center justify-center text-white text-[10px] font-bold cursor-pointer"
                             onmouseenter="showCard(event, '${record ? record.id : ''}')" onmouseleave="hideCard()" onclick="window.location.href='closing_kanban.html?entity=${record.entityId}&period=${record.period}'">
                             ${text}
                        </div>
                    </td>`;
                });
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        }

        // --- Switch View ---
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.className = 'view-btn px-3 py-1.5 rounded text-gray-500 hover:text-gray-700 transition-all');
            document.getElementById(`btn-${view}`).className = 'view-btn px-3 py-1.5 rounded bg-white text-gray-800 shadow-sm transition-all font-bold';

            document.getElementById('filter-month').classList.toggle('hidden', view !== 'period');
            document.getElementById('filter-company').classList.toggle('hidden', view !== 'entity');

            document.getElementById('matrix-container').classList.toggle('hidden', view !== 'matrix');
            document.getElementById('main-table').classList.toggle('hidden', view === 'matrix');
            document.getElementById('list-header').classList.toggle('hidden', view === 'matrix');
            document.getElementById('stats-bar').classList.toggle('hidden', view === 'matrix');

            if(view === 'period') document.getElementById('table-title').innerText = '本月任务列表';
            if(view === 'entity') document.getElementById('table-title').innerText = '历史任务记录';

            renderContent();
        }

        function renderStats() {
            const container = document.getElementById('stats-bar');
            if(currentView === 'period') {
                container.innerHTML = `
                     <div class="bg-white p-4 rounded shadow-sm border-l-4 border-green-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">已完成</p>
                        <p class="text-xl font-bold text-gray-900">1 <span class="text-xs font-normal text-gray-400">/ 4</span></p>
                     </div>
                     <div class="bg-white p-4 rounded shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">进行中</p>
                        <p class="text-xl font-bold text-gray-900">2</p>
                     </div>
                `;
            } else {
                 container.innerHTML = `
                     <div class="bg-white p-4 rounded shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">平均耗时</p>
                        <p class="text-xl font-bold text-gray-900">3.5 天</p>
                     </div>
                `;
            }
        }

        function refreshData() { renderContent(); }

        // --- Modal & Card ---
        function openStartModal() {
            const m = document.getElementById('open-modal'); m.classList.remove('hidden');
            setTimeout(() => m.children[0].classList.replace('scale-95','scale-100'), 10);
        }
        function closeStartModal() {
            const m = document.getElementById('open-modal'); m.children[0].classList.replace('scale-100','scale-95');
            setTimeout(() => m.classList.add('hidden'), 150);
        }

        const hoverCard = document.getElementById('hover-card');
        function showCard(e, id) {
            if(!id) return;
            const record = fullData.find(d => d.id === id);
            if (!record) return;
            document.getElementById('card-title').innerText = `${record.entityName}`;
            document.getElementById('card-badge').innerText = record.status === 'completed' ? '已完成' : (record.status === 'active' ? '进行中' : '未开始');
            document.getElementById('card-badge').className = `px-2 py-0.5 text-xs rounded-full ${record.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`;
            document.getElementById('card-phase').innerText = record.phase;
            document.getElementById('card-progress').innerText = record.progress + '%';

            const rect = e.target.getBoundingClientRect();
            hoverCard.style.top = (rect.bottom + 10) + 'px';
            hoverCard.style.left = (rect.left - 80) + 'px';
            hoverCard.classList.remove('hidden');
            hoverCard.style.opacity = 1;
        }
        function hideCard() { hoverCard.style.opacity = 0; setTimeout(() => hoverCard.classList.add('hidden'), 150); }

        document.addEventListener('DOMContentLoaded', () => { switchView('period'); });
    </script>
</body>
</html>