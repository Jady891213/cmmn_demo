<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预算编制任务树形看板原型 - CMMN增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Inter font and set body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 Light Background */
            color: #1f2937; /* Gray-800 Default Text Color */
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8f8f8;
        }

        /* Table-specific styles */
        .tree-table th {
            text-align: left;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            border-bottom: 2px solid #e5e7eb; /* Gray-200 */
            background-color: #f9fafb; /* Gray-50 */
            position: sticky;
            top: 0;
            z-index: 5; /* 确保列表头固定 */
        }
        .tree-table td {
            height: 100%; /* Ensure full height for background color */
        }
        /* Style for Blocked task rows */
        .row-blocked {
            color: #9ca3af !important; /* Gray-400 */
            background-color: #f9fafb;
        }
        .row-blocked:hover {
            background-color: #f3f4f6;
        }

        /* Style for Disabled Discretionary task rows (New) */
        .row-discretionary-disabled {
            color: #b3b3b3 !important; /* Lighter Gray */
            background-color: #fafafa;
            opacity: 0.8;
        }
        .row-discretionary-disabled:hover {
            background-color: #fafafa; /* No hover effect to emphasize disabled state */
        }
        .row-discretionary-disabled .text-gray-700 {
            color: #b3b3b3 !important;
        }
        .row-discretionary-disabled .text-blue-500 {
            color: #b3b3b3 !important;
        }

        /* Unified row highlight style */
        .row-active {
            background-color: #eef2ff !important; /* Indigo-50 */
            border-left: 3px solid #4f46e5; /* Indigo-600 for emphasis */
        }
        /* Revision Phase specific marker */
        .row-revision {
            background-color: #fffbeb !important; /* Amber-50 Light background */
        }

        /* Removed old detail-header-sticky CSS */
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0"></div>

    <div id="app" class="h-full flex flex-col">

        <div id="main-header" class="flex justify-between items-center flex-shrink-0 bg-white border-b border-gray-200 shadow-sm p-4">
            <div>
                <h1 class="text-xl font-bold text-indigo-600">
                    <svg class="w-6 h-6 inline-block mr-2 align-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2m-7 0h2"></path></svg>
                    2026 年度预算编制 - CMMN 案例流概览
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span class="mr-4">发起人: **系统管理员**</span>
                    <span class="mr-4">发起时间: 2025-11-01 10:30:00</span>
                    <span class="mr-4">当前版本: V1</span>
                </p>
            </div>

            <div class="flex space-x-2 flex-shrink-0">
                <button class="px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition">打印看板</button>
                <button class="px-3 py-1 text-sm font-medium text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50 transition">流程图</button>
                <button class="px-3 py-1 text-sm font-medium text-amber-500 border border-amber-500 rounded-md hover:bg-amber-50 transition">撤回流程</button>
                <button class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">终止流程</button>
            </div>
        </div>
        <div class="flex-grow flex custom-scrollbar overflow-hidden">

            <div class="w-full md:w-2/3 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col custom-scrollbar overflow-y-auto">
                <div class="flex-grow overflow-y-auto">
                    <table class="tree-table min-w-full divide-y divide-gray-200">
                        <thead class="sticky top-0">
                            <tr>
                                <th class="w-1/3">计划项/任务名称</th>
                                <th class="w-1/12">责任人</th>
                                <th class="w-1/6">进度</th>
                                <th class="w-1/6">截止日期</th>
                                <th class="w-1/6">依赖</th>
                                <th class="w-1/12 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="plan-flow-table-body" class="bg-white divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="task-detail-pane" class="w-full md:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col shadow-lg">

                <div class="flex-shrink-0 p-4 bg-white sticky top-0 z-20 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">计划项详情</h2>

                    <div id="task-detail-task-header" class="pt-2">
                        <p class="text-sm text-gray-500">请从左侧选择一个计划项查看详情。</p>
                    </div>
                    <div class="border-b pt-2"></div>
                </div>
                <div id="task-detail-content-scrollable" class="flex-grow custom-scrollbar overflow-y-auto p-4">
                    <div id="task-detail-content" class="bg-white">
                         <div class="p-10 text-center text-gray-500">
                            <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p>请从左侧表格中选择一个计划项查看详情。</p>
                        </div>
                    </div>
                </div>
                </div>
        </div>
        </div>

    <div id="activation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">激活可选任务</h3>

            <div class="space-y-4">
                <p id="modal-task-name" class="text-lg font-semibold text-indigo-600"></p>
                <input type="hidden" id="modal-phase-id">
                <input type="hidden" id="modal-dtask-id">

                <div>
                    <label for="modal-owner" class="block text-sm font-medium text-gray-700">指定负责人</label>
                    <input type="text" id="modal-owner" value="预算员/部门负责人" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-due-date" class="block text-sm font-medium text-gray-700">截止日期 (可选)</label>
                    <input type="date" id="modal-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-comment-activate" class="block text-sm font-medium text-gray-700">启动备注</label>
                    <textarea id="modal-comment-activate" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="请说明激活此可选任务的原因..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeActivationModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    取消
                </button>
                <button onclick="confirmActivation()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认激活并分配
                </button>
            </div>
        </div>
    </div>

    <div id="approval-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="approval-modal-title">财务初审结果确认</span>
            </h3>

            <p id="approval-modal-task-name" class="text-lg font-semibold text-gray-700 mb-4"></p>
            <input type="hidden" id="approval-modal-task-id">

            <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-md mb-4">
                 <p class="text-sm font-medium text-indigo-700">请选择下一步操作：</p>
                 <p class="text-xs text-indigo-600 mt-1">【确认通过】-> 进入预算锁定阶段。 【驳回】-> 退回草案编制阶段修订。</p>
            </div>

            <div>
                <label for="modal-comment-approval" class="block text-sm font-medium text-gray-700">审批意见/备注 (驳回时必填)</label>
                <textarea id="modal-comment-approval" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="输入审批意见或驳回原因..."></textarea>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeApprovalModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    弹框取消
                </button>
                <button onclick="processApproval('Reject')" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">
                    驳回 (退回修订)
                </button>
                <button onclick="processApproval('Approve')" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认通过
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CMMN Data Model (Unchanged) ---
        const kanbanToInboxMap = {
            // Kanban ID -> Inbox Task ID
            203: 7, // '资本支出计划提报'
            204: 8, // '收入预测模型核对'
            301: 1, // '财务初审与汇总'
        };

        const budgetPlanTree = [
            { id: 100, name: '项目准备与启动', type: 'Phase', progress: 100, owner: '项目经理', status: 'Completed', children: [
                { id: 101, name: '预算目标设定', type: 'Milestone', progress: 100, startDate: '2025-11-01', endDate: '2025-11-05', owner: '高管层', status: 'Completed' },
                { id: 102, name: '预算模型与工具准备', type: 'Task', progress: 100, startDate: '2025-11-01', endDate: '2025-11-10', owner: 'IT/财务部', status: 'Completed' }
            ]},
            { id: 200, name: '部门草案编制', type: 'Phase', progress: 75, owner: '财务部',
                discretionaryTasks: [
                    { id: 901, name: '进行专项成本分析', owner: '预算员', type: 'DiscretionaryTask', status: 'Available' },
                    { id: 902, name: '召开跨部门沟通会议', owner: '部门负责人', type: 'DiscretionaryTask', status: 'Available' }
                ],
                children: [
                    { id: 201, name: '下发编制模板', type: 'Task', progress: 100, startDate: '2025-11-11', endDate: '2025-11-12', owner: '财务部', status: 'Completed' },
                    { id: 202, name: '各部门费用预算提报', type: 'Task', progress: 100, startDate: '2025-11-13', endDate: '2025-11-20', owner: '各部门负责人', status: 'Completed' },
                    { id: 203, name: '【有详情】资本支出计划提报', type: 'Task', progress: 100, startDate: '2025-11-21', endDate: '2025-11-28', owner: '技术/运营部', status: 'Completed', dependencies: [202] },
                    { id: 204, name: '【有详情】收入预测模型核对', type: 'Task', progress: 100, startDate: '2025-11-29', endDate: '2025-12-05', owner: '市场部', status: 'Completed', dependencies: [202] },
                    { id: 205, name: '草案已提报 (里程碑)', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [203, 204] }
                ]
            },
            { id: 300, name: '复核与审批', type: 'Phase', progress: 10, owner: '财务总监', children: [
                { id: 301, name: '【有详情】财务初审与汇总', type: 'Task', progress: 10, startDate: '2025-12-06', endDate: '2025-12-15', owner: '财务部', status: 'Pending', dependencies: [205] },
                { id: 302, name: '高管委员会审批通过', type: 'Milestone', progress: 0, startDate: '2025-12-16', endDate: '2025-12-20', owner: '高管委', status: 'Blocked', dependencies: [301] }
            ]},
            { id: 400, name: '预算发布与锁定', type: 'Phase', progress: 0, owner: '行政管理', children: [
                { id: 401, name: '系统录入与锁定 (自动)', type: 'SystemTask', progress: 0, startDate: '2025-12-21', endDate: '2025-12-25', owner: '系统/IT部', status: 'Blocked', dependencies: [302] }
            ]}
        ];

        let activeNodeId = 205; // Initial selected node
        let expandedNodes = new Set([100, 200, 300, 400]);
        let allNodesMap = new Map(); // Flat map for quick lookup

        let stageInstances = {
            200: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }],
            300: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }]
        };
        let currentInstanceId = 1;

        // --- Core Logic Functions (Unchanged) ---
        function calculateAggregateProgress(node) {
            // ... (Same implementation as before) ...
            if (!node.children || node.children.length === 0) {
                if (node.type === 'DiscretionaryTask') {
                    return { progress: 0, count: 0, completedCount: 0 };
                }
                node.progress = typeof node.progress === 'number' ? node.progress : 0;
                const leafProgress = getEffectiveStatus(node) === 'Completed' ? 100 : node.progress;
                return {
                    progress: leafProgress,
                    count: 1,
                    completedCount: leafProgress === 100 ? 1 : 0
                };
            }

            let totalProgressSum = 0;
            let totalLeafNodeCount = 0;
            let totalCompletedCount = 0;

            node.children.forEach(child => {
                const result = calculateAggregateProgress(child);
                totalProgressSum += result.progress * result.count;
                totalLeafNodeCount += result.count;
                totalCompletedCount += result.completedCount;
            });

            if (totalLeafNodeCount > 0) {
                node.progress = Math.round(totalProgressSum / totalLeafNodeCount);
                if (totalCompletedCount === totalLeafNodeCount) {
                    node.status = 'Completed';
                } else if (totalCompletedCount > 0) {
                     node.status = 'In Progress';
                } else {
                    node.status = 'Pending';
                }
            } else {
                node.progress = 0;
                if(node.status !== 'Completed') {
                    node.status = 'Draft';
                }
            }

            return {
                progress: node.progress,
                count: totalLeafNodeCount,
                completedCount: totalCompletedCount
            };
        }

        function findNodeById(tree, id) {
            for (const node of tree) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNodeById(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function flattenAndMapNodes(tree) {
            const map = new Map();
            const processNodes = (nodes) => {
                nodes.forEach(node => {
                    map.set(node.id, node);
                    if (node.children) {
                        processNodes(node.children);
                    }
                    if (node.discretionaryTasks) {
                        node.discretionaryTasks.forEach(dTask => {
                            dTask.parentPhaseId = node.id;
                            map.set(dTask.id, dTask);
                        });
                    }
                });
            };
            processNodes(tree);
            return map;
        }

        function getEffectiveStatus(node) {
            if (node.type === 'DiscretionaryTask') {
                const parentPhase = node.parentPhaseId ? allNodesMap.get(node.parentPhaseId) : null;
                if (parentPhase && parentPhase.status === 'Completed') {
                    return 'PhaseClosed';
                }
            }

            if (node.status === 'Completed' || node.status === 'AwaitingRevision') return node.status;

            let isBlockedByDependencies = false;
            if (node.dependencies && node.dependencies.length > 0) {
                isBlockedByDependencies = node.dependencies.some(depId => {
                    const depNode = allNodesMap.get(depId);
                    return depNode && getEffectiveStatus(depNode) !== 'Completed';
                });

                if (isBlockedByDependencies) {
                    return 'Blocked';
                }

                if (node.status === 'Blocked') {
                    return 'Pending';
                }
            }

            if (node.type === 'Milestone' && node.status === 'Blocked' && !isBlockedByDependencies) {
                 return 'Pending';
            }


            return node.status || 'Draft';
        }

        function getStatusTag(status, nodeId = null) {
            let color = 'gray';
            let text = '未开始';
            if (status === 'Completed') {
                color = 'emerald';
                text = '已完成';
            } else if (status === 'Pending' || status === 'Draft' || status === 'In Progress' || status === 'Active') {
                color = 'indigo';
                text = '进行中';
            } else if (status === 'Blocked') {
                color = 'slate';
                text = '待激活';
            } else if (status === 'Available') {
                color = 'blue';
                text = '可选激活';
            } else if (status === 'AwaitingRevision') {
                color = 'amber';
                text = '驳回 (待修订)';
            } else if (status === 'PhaseClosed') {
                color = 'gray';
                text = '阶段已关闭';
            }


            if (nodeId === 200 && status !== 'Completed') {
                const currentInstance = stageInstances[200] ? stageInstances[200].length : 1;
                text = `进行中 (V${currentInstance})`;
                color = 'indigo';
            }
            return `<span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700">${text}</span>`;
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            let bgColor = '';
            if (type === 'error') bgColor = 'bg-red-600';
            else if (type === 'warning') bgColor = 'bg-amber-500';
            else bgColor = 'bg-indigo-600';

            box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0 ${bgColor}`;
            box.innerHTML = message;

            requestAnimationFrame(() => {
                box.classList.remove('translate-x-full', 'opacity-0');
                box.classList.add('translate-x-0', 'opacity-100');
            });

            setTimeout(() => {
                box.classList.remove('translate-x-0', 'opacity-100');
                box.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        }

        function openTaskInInbox(kanbanNodeId) {
            const inboxTaskId = kanbanToInboxMap[kanbanNodeId];
            if (inboxTaskId) {
                showMessage(`正在新标签页中打开待办任务中心，任务 ID: ${inboxTaskId}，并筛选流程为【财务预算 V2】`, 'info');
                const processName = '财务预算 V2';
                const url = `taskinbox.html?taskId=${inboxTaskId}&processFilter=${encodeURIComponent(processName)}`;
                // window.open(url, '_blank');
                window.location.href = url;
            } else {
                showMessage(`节点 ID ${kanbanNodeId} 暂无对应待办任务 (Inbox Task ID)。`, 'warning');
            }
        }
        // --- END Core Logic Functions ---


        // --- NEW: Dropdown Control Functions ---

        /**
         * Toggles the visibility of a task action dropdown menu.
         * Closes all other open dropdowns first.
         * @param {HTMLElement} buttonElement - The button that was clicked.
         */
        function toggleDropdown(buttonElement) {
            event.stopPropagation(); // Stop event from triggering row selection
            const menu = buttonElement.nextElementSibling;
            const isCurrentlyOpen = !menu.classList.contains('hidden');

            // 1. Close all other dropdowns
            document.querySelectorAll('.action-dropdown-menu').forEach(m => {
                if (m !== menu) {
                    m.classList.add('hidden');
                }
            });

            // 2. Toggle the current one
            if (isCurrentlyOpen) {
                menu.classList.add('hidden');
            } else {
                menu.classList.remove('hidden');
            }
        }

        /**
         * Global listener to close all open dropdowns when clicking anywhere outside of them.
         */
        document.addEventListener('click', (event) => {
            const dropdowns = document.querySelectorAll('.action-dropdown-menu');
            dropdowns.forEach(menu => {
                const container = menu.parentElement;
                // Check if the click is outside the container AND the menu is visible
                if (!container.contains(event.target) && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            });
        });

        // --- END NEW Dropdown Control Functions ---


        /**
         * Renders the action menu (Kebab Menu or system action button)
         */
        function renderActionMenu(node, effectiveStatus) {
            if (node.type === 'Phase') return '—';

            const isSystemTask = node.type === 'SystemTask';
            const isDiscretionary = node.type === 'DiscretionaryTask';
            const isMilestone = node.type === 'Milestone';

            // --- 核心优化: 任务完成、阻塞或阶段关闭时隐藏操作按钮 ---
            const isNotActionable = (
                effectiveStatus === 'Completed' ||
                effectiveStatus === 'Blocked' ||
                effectiveStatus === 'PhaseClosed'
            );

            // 1. 可选任务 (DiscretionaryTask) 逻辑
            if (isDiscretionary) {
                 if (effectiveStatus === 'Available') {
                     // 仅在状态为 Available 时显示激活按钮
                     return `
                        <button onclick="event.stopPropagation(); openActivationModal(${node.parentPhaseId}, ${node.id}, '${node.name}')" class="px-3 py-1 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            激活
                        </button>
                    `;
                 }
                 // 其他状态 (PhaseClosed, Blocked) 均隐藏
                 return '—';
            }

            // 2. 系统任务 (SystemTask) 逻辑
            if (isSystemTask) {
                if (isNotActionable) return '—'; // 非活动状态下隐藏
                // 仅在 Pending/AwaitingRevision 时显示自动执行按钮
                return `
                    <button onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'TriggerSystem')" class="px-3 py-1 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 transition">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        自动执行
                    </button>
                `;
            }

            // 3. 常规任务/里程碑：非活动状态时隐藏
            if (isNotActionable) {
                return '—';
            }


            // 4. 里程碑 (Milestone): Active (Pending, AwaitingRevision)
            if (isMilestone) {
                // 对于活动状态的里程碑，直接显示 '里程碑完成' 按钮
                return `
                    <button onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Complete')" class="px-3 py-1 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        里程碑完成
                    </button>
                `;
            }

            // 5. 常规任务 (Task): Active (Pending, In Progress, AwaitingRevision)

            const isPendingApproval = node.id === 301 && effectiveStatus === 'Pending'; // Special check for '财务初审与汇总'
            const buttonColor = isPendingApproval ? 'bg-indigo-600' : 'bg-indigo-500';
            const buttonText = isPendingApproval ? '进行审批' : '执行操作';

            let customAction = '';
            if (isPendingApproval) {
                customAction = `<a href="#" onclick="event.stopPropagation(); openApprovalModal(${node.id}, '${node.name}')" class="flex items-center px-4 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 font-semibold" role="menuitem" tabindex="-1">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    提交审批结果 (必选)
                </a>`;
            }
            // 允许 '标记为完成' 在 Pending/AwaitingRevision 状态下显示
            else {
                 customAction = `<a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Complete')" class="flex items-center px-4 py-2 text-sm text-green-700 hover:bg-green-100 font-semibold" role="menuitem" tabindex="-1">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    标记为完成
                </a>`;
            }

            // Dropdown menu for standard Tasks
            return `
                <div class="relative inline-block text-left action-dropdown-container">
                    <button onclick="toggleDropdown(this)" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-3 py-1 ${buttonColor} text-sm font-medium text-white hover:opacity-80 transition">
                        ${buttonText}
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none hidden action-dropdown-menu z-30" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            ${customAction}
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'OpenForm')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                ${isMilestone ? '查看检查点数据' : '进入表单界面'}
                            </a>
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Assign')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                重新分派责任人
                            </a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'Comment')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                评论与沟通
                            </a>
                            <a href="#" onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'ViewLog')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                查看日志
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the single row for a node in the tree table. (Unchanged)
         */
        function renderNodeRow(node, level = 0) {
            const effectiveStatus = getEffectiveStatus(node);
            const isPhase = node.type === 'Phase';
            const isMilestone = node.type === 'Milestone';
            const isDiscretionary = node.type === 'DiscretionaryTask';
            const isSystemTask = node.type === 'SystemTask';
            const isCompleted = effectiveStatus === 'Completed';
            const isBlocked = effectiveStatus === 'Blocked';
            const isPhaseClosed = effectiveStatus === 'PhaseClosed';
            const isExpanded = expandedNodes.has(node.id);
            const isRevision = node.status === 'AwaitingRevision';

            let rowClass = `cursor-pointer hover:bg-gray-50 ${node.id === activeNodeId ? 'row-active' : ''}`;
            if (isBlocked) {
                rowClass += ' row-blocked';
            } else if (isRevision) {
                rowClass += ' row-revision';
            } else if (isDiscretionary && isPhaseClosed) {
                rowClass += ' row-discretionary-disabled';
            }

            const dependenciesHtml = node.dependencies && node.dependencies.length > 0
                ? node.dependencies.map(depId => {
                    const depNode = allNodesMap.get(depId);
                    const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                    const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : 'text-slate-600';
                    const statusText = depStatus === 'Completed' ? '已达成' : '等待前置';
                    return `<button onclick="event.stopPropagation(); selectPlanNode(${depId})" class="text-xs hover:underline text-left block"><span class="font-medium text-gray-700">${depNode ? depNode.name : `ID:${depId}`}</span> <span class="${statusColor} ml-2 font-medium">${statusText}</span></button>`;
                }).join('')
                : '无依赖';

            const nameTextColor = isCompleted ? 'text-gray-400' : 'text-gray-700';

            let typeIcon = '';
            if (isPhase) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`;
            } else if (isMilestone) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
} else if (isRevision) {
                 typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.394 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            } else if (isDiscretionary) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (isSystemTask) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-1.756.426-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
            } else {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 ${nameTextColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M10 12h.01"></path></svg>`;
            }

            let html = `<tr data-node-id="${node.id}" class="${rowClass}" onclick="selectPlanNode(${node.id})">`;

            html += `<td class="py-3 px-4 text-sm font-medium whitespace-nowrap ${nameTextColor}">`;
            html += `<div style="padding-left: ${level * 1.5}rem;" class="flex items-center">`;
            if (isPhase) {
                html += `<span onclick="event.stopPropagation(); toggleExpand(${node.id})" class="mr-2 text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4 inline-block transform ${isExpanded ? 'rotate-90' : 'rotate-0'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                         </span>`;
            } else {
                html += `<span style="width: 1.5rem;"></span>`;
            }
            html += `${typeIcon} ${node.name}`;
            html += `</div></td>`;

            html += `<td class="py-3 px-4 text-sm whitespace-nowrap text-gray-600">${node.owner || '待定'}</td>`;

            html += `<td class="py-3 px-4 text-sm w-32">`;

            if (isDiscretionary && isPhaseClosed) {
                html += `<div class="mt-1">${getStatusTag('PhaseClosed', node.id)}</div>`;
            } else if (isDiscretionary) {
                 html += `<div class="mt-1">${getStatusTag(effectiveStatus, node.id)}</div>`;
            } else {
                html += `<div class="flex items-center space-x-2">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                ${isMilestone ? `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-purple-500' : 'bg-gray-200'}" style="width: ${isCompleted ? 100 : 0}%"></div>
                                ` : `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                                `}
                            </div>
                            <span class="text-xs font-medium text-gray-700 w-8 text-right">${node.progress || 0}%</span>
                        </div>
                        <div class="mt-1">${getStatusTag(effectiveStatus, node.id)}</div>
                        `;
            }
            html += `</td>`;

            const today = new Date().setHours(0, 0, 0, 0);
            const dueDate = node.endDate ? new Date(node.endDate).setHours(0, 0, 0, 0) : null;
            const isOverdue = !isCompleted && dueDate && dueDate < today;
            html += `<td class="py-3 px-4 text-sm whitespace-nowrap ${isOverdue ? 'text-red-600 font-semibold' : nameTextColor}">${node.endDate || '—'}</td>`;

            html += `<td class="py-3 px-4 text-sm whitespace-normal text-gray-600 w-40">${dependenciesHtml}</td>`;

            html += `<td class="py-3 px-4 text-center text-sm whitespace-nowrap">${renderActionMenu(node, effectiveStatus)}</td>`;

            html += `</tr>`;

            if (isPhase && isExpanded && node.children) {
                node.children.forEach(child => {
                    html += renderNodeRow(child, level + 1);
                });
            }

            if (isPhase && isExpanded && node.discretionaryTasks && node.discretionaryTasks.length > 0) {
                 node.discretionaryTasks.forEach(dTask => {
                     html += renderNodeRow(dTask, level + 1);
                 });
             }

            return html;
        }

        /**
         * Renders the details pane content for the selected node.
         * MODIFIED: Separated Task Header (Name/Status/Action Button) to a sticky area.
         */
        function renderDetailPane(node) {
            const detailTaskHeader = document.getElementById('task-detail-task-header');
            const detailContent = document.getElementById('task-detail-content');

            const initialTaskHeaderHtml = '<p class="text-sm text-gray-500">请从左侧选择一个计划项查看详情。</p>';
            const initialContentHtml = `
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            `;

            if (!node) {
                // Initial state
                detailTaskHeader.innerHTML = initialTaskHeaderHtml;
                detailContent.innerHTML = initialContentHtml;
                return;
            }

            const effectiveStatus = getEffectiveStatus(node);
            const isCompleted = effectiveStatus === 'Completed';
            const isDiscretionaryAndClosed = effectiveStatus === 'PhaseClosed';

            // --- 1. Render Task Header (Sticky Part) ---
            const actionButtonHtml = renderActionMenu(node, effectiveStatus);

            // Determine node type text
            const nodeTypeText = node.type === 'Phase' ? '阶段' : (node.type === 'Milestone' ? '里程碑' : (node.type === 'SystemTask' ? '系统任务' : (node.type === 'DiscretionaryTask' ? '可选任务' : '常规任务')));

            let taskHeaderHtml = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-2xl font-bold ${isCompleted ? 'text-emerald-600' : (isDiscretionaryAndClosed ? 'text-gray-400' : 'text-indigo-600')}">${node.name}</h3>
                    <div class="flex-shrink-0">
                         ${actionButtonHtml}
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    ${getStatusTag(effectiveStatus, node.id)}
                    <span class="text-sm text-gray-500">${nodeTypeText}</span>
                </div>
            `;

            detailTaskHeader.innerHTML = taskHeaderHtml;

            // --- 2. Render Detail Content (Scrollable Part) ---

            const dependenciesHtmlContent = node.dependencies && node.dependencies.length > 0
                ? node.dependencies.map(depId => {
                    const depNode = allNodesMap.get(depId);
                    const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                    const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : 'text-slate-600';
                    const statusText = depStatus === 'Completed' ? '已达成' : '等待前置';
                    return `<div class="flex justify-between text-sm text-gray-700"><span>${depNode ? depNode.name : `ID:${depId}`}</span><span class="${statusColor} font-medium">${statusText}</span></div>`;
                }).join('') : '<p class="text-sm text-gray-500">无前置依赖项。</p>';

            let commonDetails = `
                 <h4 class="font-semibold text-gray-700 mb-2">基本信息</h4>
                 <p class="text-gray-700"><strong>节点类型:</strong> ${nodeTypeText} (${node.type})</p>
                 <p class="text-gray-700"><strong>责任人:</strong> ${node.owner}</p>
                 <p class="text-gray-700"><strong>计划时间:</strong> ${node.startDate || '—'} - ${node.endDate || '—'}</p>
                 <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                     <p class="text-sm text-gray-600 font-medium mb-2 border-b pb-1">前置依赖项:</p>
                     ${dependenciesHtmlContent}
                 </div>
            `;

            let detailHtml = '';

            if (node.type === 'Phase') {
                const allTasks = (node.children || []).filter(c => c.type !== 'DiscretionaryTask');
                const totalTasks = allTasks.length;
                const completionProgress = node.progress;
                const completedTasks = Math.round(totalTasks * (completionProgress / 100));

                const currentInstances = stageInstances[node.id] || [];
                const historyHtml = currentInstances.map((instance, index) => {
                    const statusColor = instance.status === 'Completed' ? 'text-emerald-600' : (instance.status === 'AwaitingRevision' ? 'text-amber-600' : 'text-indigo-600');
                    const instanceStatusText = instance.status === 'AwaitingRevision' ? '驳回修订' : (instance.status === 'Completed' ? '已完成' : '进行中');
                    const instanceComment = instance.comment ? `<p class="text-xs text-gray-500 mt-1">${instance.comment}</p>` : '';
                    return `
                        <div class="mb-2 p-2 rounded-md ${instance.status === 'AwaitingRevision' ? 'bg-amber-50 border border-amber-200' : 'bg-gray-50 border border-gray-200'}">
                            <span class="font-semibold text-sm ${statusColor}">版本 ${index + 1} - ${instanceStatusText}</span>
                            <span class="text-xs text-gray-500 ml-3">${new Date(instance.timestamp).toLocaleDateString()}</span>
                            ${instanceComment}
                        </div>
                    `;
                }).join('');

                const discretionaryHtml = (node.discretionaryTasks || []).map(dTask => {
                    return `
                        <li class="p-2 border-b last:border-b-0 flex justify-between items-center">
                            <span class="text-gray-700">${dTask.name}</span>
                            ${renderActionMenu(dTask, dTask.status)}
                        </li>
                    `;
                }).join('');

                detailHtml = `
                    <h4 class="font-semibold text-gray-700 mb-2">阶段进度</h4>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="h-4 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                        </div>
                        <span class="text-lg font-bold text-gray-700 w-12 text-right">${node.progress || 0}%</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">${completedTasks} / ${totalTasks} 个关键项已完成。</p>

                    <div class="mb-6 border-b pb-4">
                         ${commonDetails}
                    </div>

                    ${(node.discretionaryTasks && node.discretionaryTasks.length > 0) ? `
                         <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">可选任务列表</h4>
                         <ul class="bg-white border rounded-lg p-3">
                             ${discretionaryHtml}
                         </ul>
                    ` : ''}

                    <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">版本历史</h4>
                    <div class="space-y-2">
                        ${historyHtml || '<p class="text-sm text-gray-500">无历史版本记录。</p>'}
                    </div>
                `;

            } else {
                // Task/Milestone/SystemTask/DTask logic
                detailHtml = `
                    ${isDiscretionaryAndClosed ? `
                         <div class="bg-gray-100 text-gray-600 p-3 rounded-lg flex items-start mb-4">
                             <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             <p class="text-sm">此可选任务所属的阶段已完成，当前任务已禁用。</p>
                         </div>
                    ` : ''}

                    ${node.status === 'AwaitingRevision' ? `
                         <div class="bg-amber-100 text-amber-700 p-3 rounded-lg flex items-start mb-4">
                             <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.394 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                             <p class="text-sm font-semibold">流程驳回要求修订。请根据审批意见完成修改并重新提交。</p>
                         </div>
                    ` : ''}

                    <div class="mb-6">
                        ${commonDetails}
                    </div>
                `;
            }

            detailContent.innerHTML = detailHtml;
        }

        /**
         * Selects a node, updates the activeNodeId, and re-renders the detail pane.
         */
        function selectPlanNode(nodeId, shouldScroll = true) {
            const newNode = allNodesMap.get(nodeId);
            if (!newNode) {
                console.error(`Node ID ${nodeId} not found.`);
                return;
            }

            const oldRow = document.querySelector(`tr[data-node-id="${activeNodeId}"]`);
            if (oldRow) {
                oldRow.classList.remove('row-active');
            }

            activeNodeId = nodeId;
            const newRow = document.querySelector(`tr[data-node-id="${activeNodeId}"]`);
            if (newRow) {
                newRow.classList.add('row-active');
                if (shouldScroll) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // Important: Scroll the detail pane content back to top when a new node is selected
            document.getElementById('task-detail-content-scrollable').scrollTo({ top: 0 });


            renderDetailPane(newNode);

            closeActivationModal();
        }

        function toggleExpand(phaseId) {
            event.stopPropagation();
            if (expandedNodes.has(phaseId)) {
                expandedNodes.delete(phaseId);
            } else {
                expandedNodes.add(phaseId);
            }
            renderTreeTable();
        }

        function renderTreeTable() {
             budgetPlanTree.forEach(phase => calculateAggregateProgress(phase));

            const tableBody = document.getElementById('plan-flow-table-body');
            let html = '';
            budgetPlanTree.forEach(node => {
                html += renderNodeRow(node, 0);
            });
            tableBody.innerHTML = html;
        }

        function updateAndRenderTree() {
            allNodesMap = flattenAndMapNodes(budgetPlanTree);
            renderTreeTable();
            selectPlanNode(activeNodeId, false);
        }

        // --- Modal/Action Handlers (Unchanged) ---
        function openApprovalModal(taskId, taskName) {
             const modal = document.getElementById('approval-modal');
             document.getElementById('approval-modal-title').innerText = taskName;
             document.getElementById('approval-modal-task-name').innerText = `正在处理任务: ${taskName}`;
             document.getElementById('approval-modal-task-id').value = taskId;
             document.getElementById('modal-comment-approval').value = '';
             modal.classList.remove('hidden');
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').classList.add('hidden');
        }

        function processApproval(result) {
            const taskId = parseInt(document.getElementById('approval-modal-task-id').value);
            const comment = document.getElementById('modal-comment-approval').value;

            closeApprovalModal();

            const node = allNodesMap.get(taskId);
            if (!node) return;

            node.status = 'Completed';
            node.progress = 100;

            if (result === 'Approve') {
                const milestone302 = allNodesMap.get(302);
                if (milestone302) {
                    milestone302.status = 'Completed';
                    milestone302.progress = 100;
                    showMessage('审批通过，流程进入【预算发布与锁定】阶段。', 'success');
                }
            } else if (result === 'Reject') {
                currentInstanceId++;
                const stageToReset = findNodeById(budgetPlanTree, 200);

                if (!stageInstances[stageToReset.id]) {
                    stageInstances[stageToReset.id] = [];
                }

                stageInstances[stageToReset.id].push({
                    instance: currentInstanceId,
                    status: 'AwaitingRevision',
                    timestamp: Date.now(),
                    comment: `审批驳回，需重新修订并提交流程 (V${currentInstanceId})。意见: ${comment}`
                });

                stageToReset.children.filter(c => c.type === 'Task').forEach(child => {
                    if (child.status === 'Completed' || child.progress > 0) {
                        child.status = 'AwaitingRevision';
                        child.progress = 0;
                    }
                });

                const milestone205 = allNodesMap.get(205);
                 if (milestone205) {
                    milestone205.status = 'Blocked';
                    milestone205.progress = 0;
                }

                stageToReset.status = 'AwaitingRevision';

                showMessage(`预算初审未通过，【${stageToReset.name}】阶段已重新打开 (V${currentInstanceId})。请检查表格中被重置的任务。`, 'warning');
            }

            updateAndRenderTree();
        }

        function openActivationModal(phaseId, dTaskId, taskName) {
            const dTask = allNodesMap.get(dTaskId);
            if (!dTask) return;

            const modal = document.getElementById('activation-modal');
            document.getElementById('modal-title').innerText = `激活可选任务：${taskName}`;
            document.getElementById('modal-task-name').innerText = taskName;
            document.getElementById('modal-phase-id').value = phaseId;
            document.getElementById('modal-dtask-id').value = dTaskId;
            document.getElementById('modal-owner').value = dTask.owner || '预算员/部门负责人';
            document.getElementById('modal-due-date').value = '';
            document.getElementById('modal-comment-activate').value = '';
            modal.classList.remove('hidden');
        }

        function closeActivationModal() {
            document.getElementById('activation-modal').classList.add('hidden');
        }

        function confirmActivation() {
            const phaseId = parseInt(document.getElementById('modal-phase-id').value);
            const dTaskId = parseInt(document.getElementById('modal-dtask-id').value);
            const owner = document.getElementById('modal-owner').value;
            const dueDate = document.getElementById('modal-due-date').value;

            const phaseNode = allNodesMap.get(phaseId);
            const dTaskIndex = phaseNode.discretionaryTasks.findIndex(t => t.id === dTaskId);
            if (dTaskIndex === -1) {
                showMessage('可选任务未找到或已被移除。', 'error');
                closeActivationModal();
                return;
            }
            const dTask = phaseNode.discretionaryTasks[dTaskIndex];

            const newTask = {
                id: dTaskId,
                name: dTask.name,
                type: 'Task',
                progress: 0,
                startDate: new Date().toISOString().split('T')[0],
                endDate: dueDate || '待定',
                owner: owner,
                status: 'Pending',
                isDiscretionary: true
            };

            phaseNode.discretionaryTasks.splice(dTaskIndex, 1);
            phaseNode.children.push(newTask);

            updateAndRenderTree();
            selectPlanNode(dTaskId);
            showMessage(`可选任务【${newTask.name}】已成功激活并分配给 ${owner}。`, 'success');

            closeActivationModal();
        }

        function handleTaskAction(taskId, actionType) {
            const node = allNodesMap.get(taskId);
            if (!node) return;

            let actionText = '';
            switch (actionType) {
                case 'TriggerSystem':
                    if (getEffectiveStatus(node) === 'Blocked') {
                        showMessage(`【${node.name}】等待前置，无法执行。请先完成依赖项。`, 'error');
                        return;
                    }
                    node.status = 'Completed';
                    node.progress = 100;
                    showMessage(`系统任务【${node.name}】模拟已自动完成。`, 'success');
                    break;
                case 'Complete':
                    if (getEffectiveStatus(node) === 'Blocked') {
                        showMessage(`【${node.name}】等待前置，无法执行。请先完成依赖项。`, 'error');
                        return;
                    }
                    node.status = 'Completed';
                    node.progress = 100;
                    showMessage(`任务【${node.name}】标记为完成。`, 'success');
                    break;
                case 'OpenForm':
                    const inboxId = kanbanToInboxMap[taskId];
                    if (inboxId) {
                        openTaskInInbox(taskId);
                        return;
                    }
                    actionText = node.type === 'Milestone' ? '查看检查点数据' : '进入表单界面';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'Assign':
                    actionText = '重新分派责任人';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'Comment':
                    actionText = '打开评论区';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                case 'ViewLog':
                    actionText = '查看流程历史日志';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
                    break;
                default:
                    actionText = '执行未知操作';
                    showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');
            }

            // Close all dropdown menus
            document.querySelectorAll('.action-dropdown-menu').forEach(d => d.classList.add('hidden'));

            updateAndRenderTree();
        }


        // 4. 初始加载逻辑
        document.addEventListener('DOMContentLoaded', () => {
            updateAndRenderTree();
        });
    </script>
</body>
</html>