<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预算编制任务树形看板原型 - CMMN增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Inter font and set body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 Light Background */
            color: #1f2937; /* Gray-800 Default Text Color */
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8f8f8;
        }

        /* Table-specific styles */
        .tree-table th {
            text-align: left;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            border-bottom: 2px solid #e5e7eb; /* Gray-200 */
            background-color: #f9fafb; /* Gray-50 */
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .tree-table td {
            height: 100%; /* Ensure full height for background color */
        }
        /* Style for Blocked task rows */
        .row-blocked {
            /* 保持灰色，符合“非警告”的要求 */
            color: #9ca3af !important; /* Gray-400 */
            background-color: #f9fafb;
        }
        .row-blocked:hover {
            background-color: #f3f4f6;
        }

        /* Style for Disabled Discretionary task rows (New) */
        .row-discretionary-disabled {
            color: #b3b3b3 !important; /* Lighter Gray */
            background-color: #fafafa;
            opacity: 0.8;
        }
        .row-discretionary-disabled:hover {
            background-color: #fafafa; /* No hover effect to emphasize disabled state */
        }
        .row-discretionary-disabled .text-gray-700 {
            color: #b3b3b3 !important;
        }
        .row-discretionary-disabled .text-blue-500 {
            color: #b3b3b3 !important;
        }

        /* Unified row highlight style */
        .row-active {
            background-color: #eef2ff !important; /* Indigo-50 */
            border-left: 3px solid #4f46e5; /* Indigo-600 for emphasis */
        }
        /* Revision Phase specific marker */
        .row-revision {
            background-color: #fffbeb !important; /* Amber-50 Light background */
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0"></div>

    <div id="app" class="h-full flex">

        <div class="w-full md:w-2/3 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col custom-scrollbar overflow-y-auto">
            <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10 shadow-sm">
                <h1 class="text-xl font-bold text-indigo-600">
                    <svg class="w-6 h-6 inline-block mr-2 align-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2m-7 0h2"></path></svg>
                    2026 年度预算编制 - CMMN 案例流概览
                </h1>
                <p class="text-sm text-gray-500 mt-1">流程灵活且事件驱动。阶段驳回后可重新打开并追踪历史版本。</p>
            </div>

            <div class="flex-grow overflow-y-auto">
                <table class="tree-table min-w-full divide-y divide-gray-200">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="w-1/3">计划项/任务名称</th>
                            <th class="w-1/12">责任人</th>
                            <th class="w-1/6">进度</th>
                            <th class="w-1/6">截止日期</th>
                            <th class="w-1/6">依赖</th>
                            <th class="w-1/12 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="plan-flow-table-body" class="bg-white divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="task-detail-pane" class="w-full md:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col custom-scrollbar overflow-y-auto shadow-lg">
            <div class="p-6 border-b border-gray-200 sticky top-0 bg-gray-50 z-10">
                <h2 class="text-xl font-bold text-gray-800">计划项详情</h2>
            </div>
            <div id="task-detail-content" class="flex-grow p-4 bg-white">
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            </div>
        </div>
    </div>

    <div id="activation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">激活可选任务</h3>

            <div class="space-y-4">
                <p id="modal-task-name" class="text-lg font-semibold text-indigo-600"></p>
                <input type="hidden" id="modal-phase-id">
                <input type="hidden" id="modal-dtask-id">

                <div>
                    <label for="modal-owner" class="block text-sm font-medium text-gray-700">指定负责人</label>
                    <input type="text" id="modal-owner" value="预算员/部门负责人" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-due-date" class="block text-sm font-medium text-gray-700">截止日期 (可选)</label>
                    <input type="date" id="modal-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-comment-activate" class="block text-sm font-medium text-gray-700">启动备注</label>
                    <textarea id="modal-comment-activate" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="请说明激活此可选任务的原因..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeActivationModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    取消
                </button>
                <button onclick="confirmActivation()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认激活并分配
                </button>
            </div>
        </div>
    </div>

    <div id="approval-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="approval-modal-title">财务初审结果确认</span>
            </h3>

            <p id="approval-modal-task-name" class="text-lg font-semibold text-gray-700 mb-4"></p>
            <input type="hidden" id="approval-modal-task-id">

            <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-md mb-4">
                 <p class="text-sm font-medium text-indigo-700">请选择下一步操作：</p>
                 <p class="text-xs text-indigo-600 mt-1">【确认通过】-> 进入预算锁定阶段。 【驳回】-> 退回草案编制阶段修订。</p>
            </div>

            <div>
                <label for="modal-comment-approval" class="block text-sm font-medium text-gray-700">审批意见/备注 (驳回时必填)</label>
                <textarea id="modal-comment-approval" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="输入审批意见或驳回原因..."></textarea>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeApprovalModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    弹框取消
                </button>
                <button onclick="processApproval('Reject')" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">
                    驳回 (退回修订)
                </button>
                <button onclick="processApproval('Approve')" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认通过
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 跳转到任务中心的新函数 (新增 processFilter 参数并新开标签页) ---
        const kanbanToInboxMap = {
            // Kanban ID -> Inbox Task ID
            203: 7, // '资本支出计划提报'
            204: 8, // '收入预测模型核对'
            301: 1, // '财务初审与汇总'
        };
        function openTaskInInbox(kanbanNodeId) {
            const inboxTaskId = kanbanToInboxMap[kanbanNodeId];
            if (inboxTaskId) {
                showMessage(`正在新标签页中打开待办任务中心，任务 ID: ${inboxTaskId}，并筛选流程为【财务预算 V2】`, 'info');

                // 关键修改：新增 processFilter 参数，并对中文进行编码
                const processName = '财务预算 V2';
                const url = `taskinbox/index.html?taskId=${inboxTaskId}&processFilter=${encodeURIComponent(processName)}`;

                // 使用 window.open() 在新标签页打开
                window.open(url, '_blank');

            } else {
                showMessage(`节点 ID ${kanbanNodeId} 暂无对应待办任务 (Inbox Task ID)。`, 'warning');
            }
        }
        // -----------------------------------------------------------------


        // Mock data for the budget plan flow (tree structure)
        const budgetPlanTree = [
            { id: 100, name: '项目准备与启动', type: 'Phase', progress: 100, owner: '项目经理', status: 'Completed', children: [
                { id: 101, name: '预算目标设定', type: 'Milestone', progress: 100, startDate: '2025-11-01', endDate: '2025-11-05', owner: '高管层', status: 'Completed' },
                { id: 102, name: '预算模型与工具准备', type: 'Task', progress: 100, startDate: '2025-11-01', endDate: '2025-11-10', owner: 'IT/财务部', status: 'Completed' }
            ]},
            { id: 200, name: '部门草案编制', type: 'Phase', progress: 75, owner: '财务部',
                // CMMN: Discretionary Tasks - Can be activated anytime during this phase
                discretionaryTasks: [
                    { id: 901, name: '进行专项成本分析', owner: '预算员', type: 'DiscretionaryTask', status: 'Available' },
                    { id: 902, name: '召开跨部门沟通会议', owner: '部门负责人', type: 'DiscretionaryTask', status: 'Available' }
                ],
                // 阶段内的任务和里程碑 (Milestone 205 是新增的，作为阶段出口检查点)
                children: [
                    { id: 201, name: '下发编制模板', type: 'Task', progress: 100, startDate: '2025-11-11', endDate: '2025-11-12', owner: '财务部', status: 'Completed' },
                    { id: 202, name: '各部门费用预算提报', type: 'Task', progress: 100, startDate: '2025-11-13', endDate: '2025-11-20', owner: '各部门负责人', status: 'Completed' },
                    { id: 203, name: '资本支出计划提报', type: 'Task', progress: 100, startDate: '2025-11-21', endDate: '2025-11-28', owner: '技术/运营部', status: 'Completed', dependencies: [202] },
                    { id: 204, name: '收入预测模型核对', type: 'Task', progress: 100, startDate: '2025-11-29', endDate: '2025-12-05', owner: '市场部', status: 'Completed', dependencies: [202] },
                    // 205 初始状态是 Blocked，但 getEffectiveStatus 会在依赖完成时将其改为 Pending
                    { id: 205, name: '所有部门草案已提报 (里程碑)', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [203, 204] }
                ]
            },
            { id: 300, name: '复核与审批', type: 'Phase', progress: 10, owner: '财务总监', children: [
                // Task 301 依赖于 Stage 200 的出口里程碑 205
                { id: 301, name: '财务初审与汇总', type: 'Task', progress: 10, startDate: '2025-12-06', endDate: '2025-12-15', owner: '财务部', status: 'Pending', dependencies: [205] },
                { id: 302, name: '高管委员会审批通过', type: 'Milestone', progress: 0, startDate: '2025-12-16', endDate: '2025-12-20', owner: '高管委', status: 'Blocked', dependencies: [301] }
            ]},
            // 移除了原有的 350 修订循环阶段，采用 Stage 200 重开逻辑
            { id: 400, name: '预算发布与锁定', type: 'Phase', progress: 0, owner: '行政管理', children: [
                // Task 401 依赖于 Milestone 302
                { id: 401, name: '系统录入与锁定 (自动)', type: 'SystemTask', progress: 0, startDate: '2025-12-21', endDate: '2025-12-25', owner: '系统/IT部', status: 'Blocked', dependencies: [302] }
            ]}
        ];

        let activeNodeId = 205; // Initial selected node to test the fix
        // 确保 200 (部门草案编制) 阶段初始展开，以便看到 203/204 任务
        let expandedNodes = new Set([100, 200, 300, 400]);
        let allNodesMap = new Map(); // Flat map for quick lookup

        // --- NEW: Tracking historical instances for stages ---
        let stageInstances = {
            // Stage ID: [ { instance: 1, status: 'Completed', timestamp: Date.now(), comment: 'Initial run', tasksCompleted: [...] } ]
            200: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }],
            300: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }]
        };
        let currentInstanceId = 1;


        // ** 2. 核心修改：递归计算父节点进度和状态的函数 **
        /**
         * 递归计算父节点的聚合进度和状态。
         * 进度 = (所有叶子节点进度之和) / (叶子节点总数)
         * 状态 = 根据子节点完成情况综合判断 ('Pending', 'In Progress', 'Completed')
         */
        function calculateAggregateProgress(node) {
            // 确保叶子节点（即没有子节点的节点）的 progress 字段是数字
            if (!node.children || node.children.length === 0) {
                // 可选任务不参与进度计算，除非它被激活 (类型变为 Task)
                if (node.type === 'DiscretionaryTask') {
                    return { progress: 0, count: 0, completedCount: 0 };
                }

                node.progress = typeof node.progress === 'number' ? node.progress : 0;

                // 叶子节点的完成状态转化为 0/100 进度
                const leafProgress = getEffectiveStatus(node) === 'Completed' ? 100 : node.progress;

                // 返回叶子节点自身的进度、计数和完成计数
                return {
                    progress: leafProgress,
                    count: 1,
                    completedCount: leafProgress === 100 ? 1 : 0
                };
            }

            let totalProgressSum = 0;
            let totalLeafNodeCount = 0;
            let totalCompletedCount = 0;

            // 递归处理子节点
            node.children.forEach(child => {
                const result = calculateAggregateProgress(child);
                // 累加所有叶子节点的进度总和（加权）
                totalProgressSum += result.progress * result.count;
                // 累加所有叶子节点的总数
                totalLeafNodeCount += result.count;
                // 累加已完成的叶子节点数
                totalCompletedCount += result.completedCount;
            });

            if (totalLeafNodeCount > 0) {
                // 计算父节点的加权平均进度
                node.progress = Math.round(totalProgressSum / totalLeafNodeCount);

                // 更新父节点状态
                if (totalCompletedCount === totalLeafNodeCount) {
                    node.status = 'Completed';
                } else if (totalCompletedCount > 0) {
                     // 部分完成时，状态为进行中
                     node.status = 'In Progress';
                } else {
                    node.status = 'Pending';
                }
            } else {
                // 如果是空阶段
                node.progress = 0;
                // 特殊处理：如果阶段内没有子任务，但其原始状态是 'Completed'，则保持 Completed
                if(node.status !== 'Completed') {
                    node.status = 'Draft';
                }
            }

            // 返回聚合结果给上一级父节点
            return {
                progress: node.progress,
                count: totalLeafNodeCount,
                completedCount: totalCompletedCount
            };
        }

        /**
         * Custom Message Box for Non-Alert
         */
        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            let bgColor = '';
            if (type === 'error') bgColor = 'bg-red-600';
            else if (type === 'warning') bgColor = 'bg-amber-500';
            else bgColor = 'bg-indigo-600';

            box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0 ${bgColor}`;
            box.innerHTML = message;

            // Animate in
            requestAnimationFrame(() => {
                box.classList.remove('translate-x-full', 'opacity-0');
                box.classList.add('translate-x-0', 'opacity-100');
            });

            // Animate out after 4 seconds
            setTimeout(() => {
                box.classList.remove('translate-x-0', 'opacity-100');
                box.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        }

        // ** 3. 修复 ReferenceError: getStatusTag 错误：将其定义为全局函数 **
        /**
         * Status Tag Generator
         * @param {string} status - 节点状态
         * @param {number} nodeId - 节点ID (用于特殊处理 Phase 200)
         */
        function getStatusTag(status, nodeId = null) {
            let color = 'gray';
            let text = '未开始';
            if (status === 'Completed') {
                color = 'emerald';
                text = '已完成';
            } else if (status === 'Pending' || status === 'Draft' || status === 'In Progress' || status === 'Active') {
                color = 'indigo';
                text = '进行中';
            // BEGIN - 阻止状态更新
            } else if (status === 'Blocked') {
                color = 'slate'; // 从 'red' 改为 'slate' (深灰色)
                text = '待激活'; // 从 '被阻止' 改为 '待激活'
            // END - 阻止状态更新
            } else if (status === 'Available') {
                color = 'blue';
                text = '可选激活';
            } else if (status === 'AwaitingRevision') {
                color = 'amber';
                text = '驳回 (待修订)';
            } else if (status === 'PhaseClosed') {
                color = 'gray';
                text = '阶段已关闭';
            }


            // For Phase 200, show current instance number
            if (nodeId === 200 && status !== 'Completed') {
                const currentInstance = stageInstances[200] ? stageInstances[200].length : 1;
                text = `进行中 (V${currentInstance})`;
                color = 'indigo';
            }
            return `<span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700">${text}</span>`;
        }


        // --- Data Manipulation and Lookup Functions (unchanged) ---

        /**
         * Recursively find a node by its ID.
         */
        function findNodeById(tree, id) {
            // Check if it's the root array (top-level phases)
            for (const node of tree) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNodeById(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        /**
         * Flattens the tree structure and creates a map for quick ID lookup.
         */
        function flattenAndMapNodes(tree) {
            const map = new Map();
            const processNodes = (nodes) => {
                nodes.forEach(node => {
                    map.set(node.id, node);
                    if (node.children) {
                        processNodes(node.children);
                    }
                    if (node.discretionaryTasks) {
                        node.discretionaryTasks.forEach(dTask => {
                            // Link discretionary task back to its parent phase ID
                            dTask.parentPhaseId = node.id;
                            map.set(dTask.id, dTask);
                        });
                    }
                });
            };
            processNodes(tree);
            return map;
        }

        /**
         * Determines the status of a node, considering its dependencies.
         */
        function getEffectiveStatus(node) {
            // Step 0: Check if it's a discretionary task and its parent phase is completed
            if (node.type === 'DiscretionaryTask') {
                const parentPhase = node.parentPhaseId ? allNodesMap.get(node.parentPhaseId) : null;
                if (parentPhase && parentPhase.status === 'Completed') {
                    return 'PhaseClosed'; // New status for disabled discretionary tasks
                }
            }

            // Step 1: Base statuses
            if (node.status === 'Completed' || node.status === 'AwaitingRevision') return node.status;

            let isBlockedByDependencies = false;
            if (node.dependencies && node.dependencies.length > 0) {
                isBlockedByDependencies = node.dependencies.some(depId => {
                    const depNode = allNodesMap.get(depId);
                    // Use getEffectiveStatus for dependency check
                    return depNode && getEffectiveStatus(depNode) !== 'Completed';
                });

                if (isBlockedByDependencies) {
                    return 'Blocked';
                }

                // FIX: If dependencies are met, but stored status is 'Blocked', change effective status to 'Pending'
                if (node.status === 'Blocked') {
                    return 'Pending';
                }
            }

            // Step 2: Milestone Dependency Logic
            // If it's a Milestone that was initialized as 'Blocked' (like 205),
            // but its dependencies are now met (we reached here),
            // we should treat its effective status as 'Pending' (Ready).
            if (node.type === 'Milestone' && node.status === 'Blocked') {
                 return 'Pending';
            }

            // Step 3: Phase status calculation (handled by calculateAggregateProgress, we trust its result here)
            if (node.type === 'Phase' && node.status !== 'Completed') {
                return node.status;
            }

            // Step 4: For Tasks/Discretionary tasks, return the stored status if not blocked
            return node.status;
        }

        /**
         * Toggles the expansion/collapse state of a Phase node.
         */
        function toggleExpansion(id) {
            if (expandedNodes.has(id)) {
                expandedNodes.delete(id);
            } else {
                expandedNodes.add(id);
            }
            renderTreeTable();
            selectPlanNode(activeNodeId, false); // Keep the current selection highlighted
        }

        /**
         * 查找任何节点（包括常规任务和可选任务）的直接父级阶段节点。
         *
         * @param {number} nodeId - 要查找的节点ID。
         * @returns {Object|null} 父级阶段节点对象，如果找不到则返回 null。
         */
        function findParentPhase(nodeId) {
            // Use the stored parentPhaseId for quick lookup of discretionary tasks
            const node = allNodesMap.get(nodeId);
            if (node && node.type === 'DiscretionaryTask' && node.parentPhaseId) {
                return allNodesMap.get(node.parentPhaseId);
            }

            // For regular tasks, use the recursive search
            function find(nodes, targetId, parent = null) {
                for (const node of nodes) {
                    if (node.id === targetId) {
                        // 找到了常规任务/里程碑
                        return parent;
                    }

                    if (node.children) {
                        // 如果当前节点是 Phase，则它成为其 children 的潜在 parent
                        const newParent = node.type === 'Phase' ? node : parent;
                        const found = find(node.children, targetId, newParent);
                        if (found) return found;
                    }
                }
                return null;
            }
            // 从整个树的根开始搜索
            // Note: This won't find discretionary tasks if they are not active (i.e. not in children list)
            return find(budgetPlanTree, nodeId, null);
        }

        // --- Rendering Functions (mostly unchanged, using calculated progress) ---

        /**
         * Renders the action menu (Kebab Menu or system action button)
         */
        function renderActionMenu(node, effectiveStatus) {
            if (node.type === 'Phase') return '—';
            const isSystemTask = node.type === 'SystemTask';
            const isDiscretionary = node.type === 'DiscretionaryTask';

            const isDisabled = effectiveStatus === 'Completed' || effectiveStatus === 'Blocked' || effectiveStatus === 'PhaseClosed';

            if (isSystemTask) {
                // System tasks only have one action: TriggerSystem
                return `
                    <button onclick="event.stopPropagation(); handleTaskAction(${node.id}, 'SystemExecute')" ${isDisabled ? 'disabled' : ''} class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-md hover:bg-blue-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10h16V7M4 7h16M4 7L12 3l8 4M12 3v18"></path></svg>
                        ${effectiveStatus === 'Completed' ? '已执行' : '系统执行'}
                    </button>
                `;
            }

            if (isDisabled && effectiveStatus === 'Blocked') {
                 // 更新 Blocked 状态文案
                 return '<span class="text-sm text-gray-400">等待前置</span>';
            }

            if (isDiscretionary) {
                 if (effectiveStatus === 'PhaseClosed') {
                    return '<span class="text-sm text-gray-400">阶段已完成</span>';
                 }

                 if (effectiveStatus === 'Available') {
                     const parentPhase = allNodesMap.get(node.parentPhaseId); // Use direct lookup
                     // Check if phase is completed for a fallback
                     const phaseCompleted = parentPhase && parentPhase.status === 'Completed';

                     // If phase is completed, the effectiveStatus should have been PhaseClosed,
                     // but as a fallback/safety, we check again
                     if (phaseCompleted) return '<span class="text-sm text-gray-400">阶段已完成</span>';

                     // Enabled Activation button
                     return `
                        <button onclick="event.stopPropagation(); showActivationModal(${node.parentPhaseId}, ${node.id}, '${node.name}')" class="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-md hover:bg-green-700 transition">
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            激活
                        </button>
                    `;
                 }
            }


            // Dropdown menu for standard Tasks/Milestones
            const isCompleted = effectiveStatus === 'Completed';
            const buttonColor = isCompleted ? 'bg-emerald-500' : 'bg-indigo-500';
            const buttonText = isCompleted ? '已完成' : '执行操作';

            return `
                <div class="relative inline-block text-left" x-data="{ open: false }">
                    <button onclick="event.stopPropagation(); this.nextElementSibling.classList.toggle('hidden')" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-3 py-1 ${buttonColor} text-sm font-medium text-white hover:opacity-80 transition">
                        ${buttonText}
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none z-20" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="#" onclick="event.preventDefault(); event.stopPropagation(); handleRowAction(${node.id}, 'OpenForm')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                ${isCompleted ? '查看结果' : '进入表单/数据'}
                            </a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="#" onclick="event.preventDefault(); event.stopPropagation(); handleTaskAction(${node.id}, 'Complete')" ${isCompleted ? 'class="hidden"' : 'class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"'} role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                确认完成
                            </a>
                            <a href="#" onclick="event.preventDefault(); event.stopPropagation(); handleRowAction(${node.id}, 'Assign')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                分派任务
                            </a>
                             <a href="#" onclick="event.preventDefault(); event.stopPropagation(); handleRowAction(${node.id}, 'Comment')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                评论
                            </a>
                        </div>
                        <div class="py-1" role="none">
                            <a href="#" onclick="event.preventDefault(); event.stopPropagation(); handleRowAction(${node.id}, 'ViewLog')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                查看日志
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }


        /**
         * Renders the single row for a node in the tree table.
         */
        function renderNodeRow(node, level = 0) {
            const effectiveStatus = getEffectiveStatus(node);
            const isPhase = node.type === 'Phase';
            const isMilestone = node.type === 'Milestone';
            const isDiscretionary = node.type === 'DiscretionaryTask';
            const isSystemTask = node.type === 'SystemTask'; // New check for system icon
            const isCompleted = effectiveStatus === 'Completed';
            const isBlocked = effectiveStatus === 'Blocked';
            const isPhaseClosed = effectiveStatus === 'PhaseClosed'; // New check for disabled discretionary
            const isExpanded = expandedNodes.has(node.id);
            const isRevision = node.status === 'AwaitingRevision';

            // Set row class based on status
            let rowClass = `cursor-pointer hover:bg-gray-50 ${node.id === activeNodeId ? 'row-active' : ''}`;
            if (isBlocked) {
                rowClass += ' row-blocked';
            } else if (isRevision) {
                rowClass += ' row-revision';
            } else if (isDiscretionary && isPhaseClosed) {
                 rowClass += ' row-discretionary-disabled';
            }


            // Dependencies Text (with link to dependency node)
            const dependenciesHtml = node.dependencies ? node.dependencies.map(depId => {
                const depNode = allNodesMap.get(depId);
                const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                // BEGIN - 依赖项文案和颜色更新
                const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : (depStatus === 'Blocked' ? 'text-slate-600' : 'text-indigo-600');
                const statusText = depStatus === 'Completed' ? '已达成' : (depStatus === 'Blocked' ? '等待前置' : '待处理'); // 文案更新
                // END - 依赖项文案和颜色更新

                // 修复：添加 event.stopPropagation() 到依赖项链接，防止其触发 selectPlanNode
                return `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); selectPlanNode(${depId}, true);" class="inline-block text-xs font-medium ${statusColor} hover:underline">${depNode ? depNode.name : `ID:${depId}`} (${statusText})</a>`;
            }).join('<br>') : '—';


            // Indentation and Icon
            const padding = (level * 1.5) + 'rem';
            let typeIcon;
            if (isPhase) {
                typeIcon = isExpanded
                    ? `<svg class="w-4 h-4 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`
                    : `<svg class="w-4 h-4 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
            } else if (isMilestone) {
                // FIX: Milestone Icon changed to Flag
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H7a2 2 0 01-2 2h-1z"></path></svg>`;
            } else if (isDiscretionary) {
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (isSystemTask) {
                // FIX: SystemTask Icon changed to Gear/Automation
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
            }
            else { // Task
                typeIcon = `<svg class="w-4 h-4 inline-block mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>`;
            }

            let html = `<tr id="node-${node.id}" class="${rowClass}" onclick="selectPlanNode(${node.id}, false);">`;

            // Name Column
            html += `<td class="py-3 px-4 text-sm font-medium whitespace-nowrap" style="padding-left: ${padding};">`;
            const nameTextColor = isBlocked || isPhaseClosed ? 'text-gray-400' : 'text-gray-700';
            html += `<div class="flex items-center">`;


            if (isPhase) {
                // Phase is clickable to expand/collapse
                // 修复：添加 event.stopPropagation() 到 Phase 展开/收起按钮
                html += `<a href="#" onclick="event.preventDefault(); event.stopPropagation(); toggleExpansion(${node.id})" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-semibold">`;
            } else {
                // Task/Milestone/Discretionary
                html += `<span class="inline-flex items-center ${nameTextColor}">`;
            }

            html += `
                ${typeIcon}
                ${node.name}
                ${isDiscretionary ? '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700 font-semibold">可选任务</span>' : ''}
                ${isPhase && node.repetition ? '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700 font-semibold">CMMN Looped</span>' : ''}
            `;
            // Remove discretionary tag color when disabled
            if (isDiscretionary && isPhaseClosed) {
                 html = html.replace('bg-blue-100 text-blue-700', 'bg-gray-100 text-gray-400');
            }


            if (isPhase) {
                html += `</a>`;
            } else {
                html += `</span>`;
            }
            html += `</div></td>`;

            // Owner Column
            html += `<td class="py-3 px-4 text-sm whitespace-nowrap ${nameTextColor}">${node.owner || '—'}</td>`;

            // Progress Column
            html += `<td class="py-3 px-4 text-sm w-32">`;
            if (isDiscretionary && isPhaseClosed) {
                 html += `<div class="mt-1">${getStatusTag('PhaseClosed', node.id)}</div>`;
            } else {
                html += `<div class="flex items-center space-x-2">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                ${isMilestone ? `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-purple-500' : 'bg-gray-200'}" style="width: ${isCompleted ? 100 : 0}%"></div>
                                ` : `
                                    <div class="h-2.5 rounded-full ${isCompleted ? 'bg-emerald-500' : 'bg-indigo-500'}" style="width: ${node.progress || 0}%"></div>
                                `}
                            </div>
                            <span class="text-xs font-medium text-gray-700 w-8 text-right">${node.progress || 0}%</span>
                        </div>
                        <div class="mt-1">${getStatusTag(effectiveStatus, node.id)}</div>
                    `;
            }
            html += `</td>`;

            // Due Date Column
            const today = new Date().setHours(0, 0, 0, 0);
            const dueDate = node.endDate ? new Date(node.endDate).setHours(0, 0, 0, 0) : null;
            const isOverdue = !isCompleted && dueDate && dueDate < today;
            html += `<td class="py-3 px-4 text-sm whitespace-nowrap ${isOverdue ? 'text-red-600 font-semibold' : nameTextColor}">${node.endDate || '—'}</td>`;

            // Dependencies Column
            html += `<td class="py-3 px-4 text-sm whitespace-normal text-gray-600 w-40">${dependenciesHtml}</td>`;

            // Action Column
            html += `<td class="py-3 px-4 text-center whitespace-nowrap">${renderActionMenu(node, effectiveStatus)}</td>`;

            html += `</tr>`;

            // Recursively render children if expanded and not a discretionary task
            if (isPhase && isExpanded && node.children) {
                node.children.forEach(child => {
                    html += renderNodeRow(child, level + 1);
                });
            }

            // Render discretionary tasks if applicable
            if (isPhase && isExpanded && node.discretionaryTasks) {
                node.discretionaryTasks.forEach(dTask => {
                    // Pass the parent phase ID to the discretionary task for status check
                    dTask.parentPhaseId = node.id;
                    html += renderNodeRow(dTask, level + 1);
                });
            }

            return html;
        }


        /**
         * Renders the detail pane for the selected node.
         */
        function selectPlanNode(id, scrollToRow = true) {
            const node = allNodesMap.get(id);
            if (!node) return;

            // 1. Update Active State
            const prevActiveRow = document.querySelector('.row-active');
            if (prevActiveRow) {
                prevActiveRow.classList.remove('row-active');
            }
            const newActiveRow = document.getElementById(`node-${id}`);
            if (newActiveRow) {
                newActiveRow.classList.add('row-active');
                activeNodeId = id;
                if (scrollToRow) {
                    newActiveRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                 // If row is not visible (collapsed phase), we still update activeNodeId
                 activeNodeId = id;
            }

            const detailContent = document.getElementById('task-detail-content');
            const effectiveStatus = getEffectiveStatus(node);
            const isCompleted = effectiveStatus === 'Completed';

            // 2. Render Detail Content
            let detailHtml = '';

            // Common Details
            const dependenciesHtml = node.dependencies ? node.dependencies.map(depId => {
                const depNode = allNodesMap.get(depId);
                const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                // 更新 detail pane 里的依赖项文案和颜色
                const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : 'text-slate-600';
                const statusText = depStatus === 'Completed' ? '已达成' : '等待前置';
                return `<div class="flex justify-between text-sm text-gray-700"><span>${depNode ? depNode.name : `ID:${depId}`}</span><span class="${statusColor} font-medium">${statusText}</span></div>`;
            }).join('') : '<p class="text-sm text-gray-500">无前置依赖项。</p>';

            const commonDetails = `
                <p class="text-gray-700"><strong>节点类型:</strong> ${node.type === 'Phase' ? '阶段 (Phase)' : (node.type === 'Milestone' ? '里程碑 (Milestone)' : (node.type === 'SystemTask' ? '系统任务 (SystemTask)' : '常规任务 (Task)'))}</p>
                <p class="text-gray-700"><strong>责任人:</strong> ${node.owner}</p>
                <p class="text-gray-700"><strong>计划时间:</strong> ${node.startDate || '—'} - ${node.endDate || '—'}</p>

                <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-600 font-medium mb-2 border-b pb-1">前置依赖项:</p>
                    ${dependenciesHtml}
                </div>
            `;

            // 3. Phase Details (Stage)
            if (node.type === 'Phase') {
                const allTasks = node.children.filter(c => c.type === 'Task' || c.type === 'SystemTask' || c.type === 'DiscretionaryTask');
                const totalTasks = allTasks.length;
                // Since progress is calculated recursively, we just read it.
                const completionProgress = node.progress;
                const completedTasks = Math.round(totalTasks * (completionProgress / 100));

                // Instance history
                const currentInstances = stageInstances[node.id] || [];
                const historyHtml = currentInstances.map((instance, index) => {
                    const statusColor = instance.status === 'Completed' ? 'text-emerald-600' : 'text-indigo-600';
                    return `
                        <div class="mb-2 p-2 border-b last:border-b-0">
                            <span class="font-semibold ${statusColor}">V${instance.instance}</span>:
                            <span class="text-sm text-gray-700">${instance.comment}</span>
                            <span class="text-xs text-gray-400">(${new Date(instance.timestamp).toLocaleDateString()})</span>
                        </div>
                    `;
                }).reverse().join(''); // Show latest first


                // Discretionary Task list
                const discretionaryHtml = node.discretionaryTasks ? node.discretionaryTasks.map(dTask => {
                    // Check effective status again
                    dTask.parentPhaseId = node.id;
                    const dStatus = getEffectiveStatus(dTask);
                    const isClosed = dStatus === 'PhaseClosed';

                    const dColor = isClosed ? 'bg-gray-100 text-gray-400' : (dStatus === 'Available' ? 'bg-blue-100 text-blue-700' : (dStatus === 'Completed' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-700'));
                    const dText = isClosed ? '已禁用' : dStatus;

                    return `
                        <li class="flex justify-between items-center py-1">
                            <span class="text-gray-700 text-sm ${isClosed ? 'line-through' : ''}">${dTask.name}</span>
                            <span class="px-2 py-0.5 text-xs rounded-full font-semibold ${dColor}">${dText}</span>
                        </li>
                    `;
                }).join('') : '<p class="text-sm text-gray-500">无可选任务。</p>';

                detailHtml = `
                    <h3 class="text-2xl font-bold text-indigo-600 mb-2">${node.name}</h3>
                    <div class="flex items-center space-x-3 mb-6">
                        ${getStatusTag(effectiveStatus, node.id)}
                        <span class="text-sm text-gray-500">阶段 (Phase)</span>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                        <h4 class="font-semibold text-gray-700 mb-2">状态摘要</h4>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">任务完成度:</span>
                            <span class="text-sm font-semibold text-gray-800">${completedTasks} / ${totalTasks} (${completionProgress}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div class="h-2.5 rounded-full bg-indigo-500" style="width: ${completionProgress}%"></div>
                        </div>
                    </div>

                    <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">阶段实例历史 (V${currentInstances.length})</h4>
                    <div class="bg-white border rounded-lg p-3 max-h-48 overflow-y-auto">
                        ${historyHtml}
                    </div>

                    <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">可选任务列表</h4>
                    <ul class="bg-white border rounded-lg p-3">
                        ${discretionaryHtml}
                    </ul>
                `;

            } else {
                // 4. Task/Milestone/Discretionary Details
                const isDiscretionaryAndClosed = effectiveStatus === 'PhaseClosed';

                detailHtml = `
                    <h3 class="text-2xl font-bold ${isCompleted ? 'text-emerald-600' : (isDiscretionaryAndClosed ? 'text-gray-400' : 'text-indigo-600')} mb-2">${node.name}</h3>
                    <div class="flex items-center space-x-3 mb-6">
                        ${getStatusTag(effectiveStatus, node.id)}
                        <span class="text-sm text-gray-500">${node.type}</span>
                    </div>

                    ${isDiscretionaryAndClosed ? `
                        <div class="bg-gray-100 text-gray-600 p-3 rounded-lg flex items-start mb-4">
                             <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             <p class="text-sm">此可选任务所属的阶段已完成，当前任务已禁用。</p>
                        </div>
                    ` : ''}

                    ${node.status === 'AwaitingRevision' ? `
                        <div class="bg-amber-100 text-amber-700 p-3 rounded-lg flex items-start mb-4">
                             <svg class="w-5 h-5 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                             <p class="text-sm">此任务处于【驳回】状态，等待前序阶段 (V${stageInstances[200].length}) 重新提交流程。</p>
                        </div>
                    ` : ''}

                    <div class="space-y-2 mb-6">
                        ${commonDetails}
                    </div>

                    ${isCompleted ? `
                        <div class="mt-8 pt-4 border-t border-gray-200">
                             <p class="text-lg font-semibold text-emerald-600 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                任务已于 ${new Date().toLocaleDateString()} 完成
                             </p>
                             <p class="text-sm text-gray-500 mt-2">（此为模拟完成时间）</p>
                        </div>
                    ` : ''}

                `;
            }

            detailContent.innerHTML = detailHtml;
        }

        /**
         * Main function to render the entire tree table.
         */
        function renderTreeTable() {
            const tableBody = document.getElementById('plan-flow-table-body');
            let totalHtml = '';

            // Render top-level phases
            budgetPlanTree.forEach(node => {
                totalHtml += renderNodeRow(node, 0);
            });

            tableBody.innerHTML = totalHtml;
        }

        /**
         * 集中处理数据更新和渲染，确保进度计算在渲染前完成
         */
        function updateAndRenderTree() {
            // 1. 重新映射节点 (必须在计算进度前完成，因为需要 parentPhaseId)
            allNodesMap = flattenAndMapNodes(budgetPlanTree);

            // 2. 计算所有父节点的聚合进度和状态（从根节点开始）
            // 迭代 budgetPlanTree 数组中的每个顶级阶段
            budgetPlanTree.forEach(stage => {
                calculateAggregateProgress(stage);
            });

            // 3. 重新渲染表格
            renderTreeTable();

            // 4. 重新选中当前节点（保持高亮和详情）
            if (activeNodeId) {
                // 确保在渲染后，详情面板会正确显示
                selectPlanNode(activeNodeId, false);
            }
        }


        // --- Modal Functions (for Discretionary Tasks) ---

        function showActivationModal(phaseId, dTaskId, taskName) {
            if (phaseId === 'null' || phaseId === null) {
                showMessage('无法激活：未找到任务所属的父级阶段。', 'error');
                return;
            }
            const modal = document.getElementById('activation-modal');
            const phaseNode = allNodesMap.get(phaseId);
            const dTask = allNodesMap.get(dTaskId);

            // Prevent activation if the phase is completed (redundant check, but safe)
            if (phaseNode.status === 'Completed' || getEffectiveStatus(dTask) === 'PhaseClosed') {
                 showMessage('该可选任务所属阶段已完成，无法激活。', 'error');
                 return;
            }

            document.getElementById('modal-title').textContent = `激活可选任务：${taskName}`;
            document.getElementById('modal-task-name').textContent = taskName;
            document.getElementById('modal-phase-id').value = phaseId;
            document.getElementById('modal-dtask-id').value = dTaskId;

            // Set default owner based on discretionary task data
            document.getElementById('modal-owner').value = dTask.owner || '预算员/部门负责人';

            modal.classList.remove('hidden');
        }

        function closeActivationModal() {
            document.getElementById('activation-modal').classList.add('hidden');
        }

        function confirmActivation() {
            const phaseId = parseInt(document.getElementById('modal-phase-id').value);
            const dTaskId = parseInt(document.getElementById('modal-dtask-id').value);
            const owner = document.getElementById('modal-owner').value;
            const dueDate = document.getElementById('modal-due-date').value;
            // const comment = document.getElementById('modal-comment-activate').value; // Comment field exists but is not used in data model yet

            // 1. Find the parent phase and discretionary task
            const phaseNode = allNodesMap.get(phaseId);

            // 必须在 phaseNode.discretionaryTasks 数组中找到并移除
            const dTaskIndex = phaseNode.discretionaryTasks.findIndex(t => t.id === dTaskId);
            if (dTaskIndex === -1) {
                 showMessage('可选任务未找到或已被移除。', 'error');
                 closeActivationModal();
                 return;
            }
            const dTask = phaseNode.discretionaryTasks[dTaskIndex];

            // 2. Convert DiscretionaryTask to a regular Task and add it to the phase's children
            const newTask = {
                id: dTaskId, // Keep the same ID
                name: dTask.name,
                type: 'Task', // Change type to regular Task
                progress: 0,
                startDate: new Date().toISOString().split('T')[0],
                endDate: dueDate || '待定',
                owner: owner,
                status: 'Pending',
                isDiscretionary: true // Marker for UI
            };

            // Remove from discretionaryTasks list
            phaseNode.discretionaryTasks.splice(dTaskIndex, 1);

            // Add to children list (this task now participates in progress calculation)
            phaseNode.children.push(newTask);

            // 3. Update all data and render
            closeActivationModal();
            showMessage(`可选任务【${dTask.name}】已激活并分配给 ${owner}。`, 'success');

            // Update the tree with new task and re-render
            updateAndRenderTree();
        }

        // --- NEW Approval Modal Functions (for Task 301) ---

        function showApprovalModal(taskId) {
            const node = allNodesMap.get(taskId);
            if (!node || node.type !== 'Task' || taskId !== 301) return;

            // Prevent showing modal if already completed
            if (getEffectiveStatus(node) === 'Completed') {
                showMessage(`【${node.name}】已完成，无需重复操作。`, 'warning');
                return;
            }
             if (getEffectiveStatus(node) === 'Blocked') {
                // 更新 Blocked 状态文案
                showMessage(`【${node.name}】等待前置，无法完成。请先完成依赖项。`, 'error');
                return;
            }

            document.getElementById('approval-modal-task-name').textContent = `任务: ${node.name}`;
            document.getElementById('approval-modal-task-id').value = taskId;
            document.getElementById('modal-comment-approval').value = ''; // Clear comment field

            document.getElementById('approval-modal').classList.remove('hidden');
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').classList.add('hidden');
        }

        /**
         * Processes the approval/rejection decision for Task 301
         * @param {string} result - 'Approve' or 'Reject'
         */
        function processApproval(result) {
            const taskId = parseInt(document.getElementById('approval-modal-task-id').value);
            const node = allNodesMap.get(taskId);
            const comment = document.getElementById('modal-comment-approval').value.trim();

            if (!node || taskId !== 301) return;

            if (result === 'Reject' && comment.length < 5) {
                alert('驳回操作必须填写至少 5 个字的审批意见/驳回原因。');
                return;
            }

            // Close the modal first
            closeApprovalModal();

            // --- Common Completion Logic for 301 ---
            node.status = 'Completed';
            node.progress = 100;
            showMessage(`任务【${node.name}】模拟已完成。`, 'success');

            // --- Approval / Rejection Branching ---
            if (result === 'Approve') {
                 // 1. Mark Milestone 302 as completed (triggering next stage)
                 const milestone302 = allNodesMap.get(302);
                 if (milestone302) {
                     milestone302.status = 'Completed';
                     milestone302.progress = 100;
                     showMessage('审批通过，流程进入【预算发布与锁定】阶段。', 'success');
                 }
            } else if (result === 'Reject') {
                // --- CMMN REVISION/LOOP LOGIC (Reject) ---

                // 1. Increment Instance ID and Record History
                currentInstanceId++;
                const stageToReset = findNodeById(budgetPlanTree, 200); // Phase 200 (部门草案编制)

                stageInstances[stageToReset.id].push({
                    instance: currentInstanceId,
                    status: 'AwaitingRevision',
                    timestamp: Date.now(),
                    comment: `审批驳回，需重新修订并提交流程 (V${currentInstanceId})。意见: ${comment}`
                });

                // 2. Reset dependent tasks in the target stage (Phase 200) and mark them for revision
                stageToReset.children.filter(c => c.type === 'Task').forEach(child => {
                    // Reset only the tasks that were completed/in-progress
                    if (child.status === 'Completed' || child.progress > 0) {
                        child.status = 'AwaitingRevision'; // Custom status for revision highlight
                        child.progress = 0;
                    }
                });

                // 3. Mark Task 301 as AwaitingRevision (since it needs to be run again after revision)
                node.status = 'AwaitingRevision';
                node.progress = 0;

                // 4. Reset the exit milestone 205
                const milestone205 = allNodesMap.get(205);
                milestone205.status = 'Blocked';
                milestone205.progress = 0;

                // 5. Update the Stage (200)
                stageToReset.status = 'Pending'; // Set Phase 200 to Pending

                showMessage(`预算初审驳回，【${stageToReset.name}】阶段已重新打开 (V${currentInstanceId})。请检查表格中被重置的任务。`, 'warning');
            }


            // 4. Re-render the table and details
            updateAndRenderTree();

            // Show initial message in detail pane after completion
            const detailContent = document.getElementById('task-detail-content');
            detailContent.innerHTML = `
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            `;
        }

        // --- Action Handlers ---

        /**
         * Simulates task action execution (Complete, SystemExecute, Reject, etc.)
         */
        function handleTaskAction(taskId, action) {
            const node = allNodesMap.get(taskId);
            if (!node) return;

            const effectiveStatus = getEffectiveStatus(node);

            if (action === 'Complete') {
                if (taskId === 301) {
                    // Intercept Task 301 completion to show the custom modal
                    showApprovalModal(taskId);
                    return;
                }

                // --- Standard Completion Logic for other Tasks ---

                if (effectiveStatus === 'Blocked') {
                    // 更新 Blocked 状态文案
                    showMessage(`【${node.name}】等待前置，无法完成。请先完成依赖项。`, 'error');
                    return;
                }
                if (node.status === 'Completed') {
                    showMessage(`【${node.name}】已完成，无需重复操作。`, 'warning');
                    return;
                }

                // Set to Completed
                node.status = 'Completed';
                node.progress = 100;
                showMessage(`任务【${node.name}】模拟已完成。`, 'success');

            } else if (action === 'SystemExecute') {
                // System task logic (e.g., 401: System Lock)
                if (effectiveStatus === 'Blocked') {
                    // 更新 Blocked 状态文案
                    showMessage(`【${node.name}】等待前置，无法执行。请先完成依赖项。`, 'error');
                    return;
                }
                node.status = 'Completed';
                node.progress = 100;
                showMessage(`系统任务【${node.name}】模拟已自动完成。`, 'success');
            }

            // 3. Re-render the table and details
            updateAndRenderTree();

            // Show initial message in detail pane after completion
            const detailContent = document.getElementById('task-detail-content');
            detailContent.innerHTML = `
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            `;
        }

        /**
         * Action for dropdown menus (OpenForm, Assign, Comment, ViewLog)
         */
        function handleRowAction(taskId, actionType) {
            const node = allNodesMap.get(taskId);
            if (!node) return;

            let actionText = '';
            switch (actionType) {
                case 'TriggerSystem': // Simulate triggering a system task
                    handleTaskAction(taskId, 'SystemExecute');
                    return;
                case 'OpenForm':
                    const inboxId = kanbanToInboxMap[taskId];
                    if (inboxId) {
                        openTaskInInbox(taskId);
                        return;
                    }
                    actionText = node.type === 'Milestone' ? '查看检查点数据' : '进入表单界面';
                    break;
                case 'Assign':
                    actionText = '重新分派责任人';
                    break;
                case 'Comment':
                    actionText = '打开评论区';
                    break;
                case 'ViewLog':
                    actionText = '查看流程历史日志';
                    break;
                default:
                    actionText = '执行未知操作';
            }
            showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');

            // Close all dropdown menus
            document.querySelectorAll('.origin-top-right').forEach(d => d.classList.add('hidden'));
        }


        // 4. 初始加载逻辑 (调用新的统一更新函数)
        document.addEventListener('DOMContentLoaded', () => {
            // 初始加载时调用 updateAndRenderTree 即可完成所有初始化：
            // 节点映射 -> 进度计算 -> 表格渲染 -> 节点选中
            updateAndRenderTree();
        });
    </script>
</body>
</html>
