<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预算编制任务树形看板原型 - CMMN增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Inter font and set body styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Gray-100 Light Background */
            color: #1f2937; /* Gray-800 Default Text Color */
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f8f8f8;
        }

        /* Table-specific styles */
        .tree-table th {
            text-align: left;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            border-bottom: 2px solid #e5e7eb; /* Gray-200 */
            background-color: #f9fafb; /* Gray-50 */
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .tree-table td {
            height: 100%; /* Ensure full height for background color */
        }
        /* Style for Blocked task rows */
        .row-blocked {
            color: #9ca3af !important; /* Gray-400 */
            background-color: #f9fafb;
        }
        .row-blocked:hover {
            background-color: #f3f4f6;
        }

        /* Unified row highlight style */
        .row-active {
            background-color: #eef2ff !important; /* Indigo-50 */
            border-left: 3px solid #4f46e5; /* Indigo-600 for emphasis */
        }
        /* Revision Phase specific marker */
        .row-revision {
            background-color: #fffbeb !important; /* Amber-50 Light background */
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0"></div>

    <div id="app" class="h-full flex">

        <div class="w-full md:w-2/3 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col custom-scrollbar overflow-y-auto">
            <div class="p-4 border-b border-gray-200 sticky top-0 bg-white z-10 shadow-sm">
                <h1 class="text-xl font-bold text-indigo-600">
                    <svg class="w-6 h-6 inline-block mr-2 align-top" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2m-7 0h2"></path></svg>
                    2026 年度预算编制 - CMMN 案例流概览
                </h1>
                <p class="text-sm text-gray-500 mt-1">流程灵活且事件驱动。阶段驳回后可重新打开并追踪历史版本。</p>
            </div>

            <div class="flex-grow overflow-y-auto">
                <table class="tree-table min-w-full divide-y divide-gray-200">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="w-1/3">计划项/任务名称</th>
                            <th class="w-1/12">责任人</th>
                            <th class="w-1/6">进度</th>
                            <th class="w-1/6">截止日期</th>
                            <th class="w-1/6">依赖</th>
                            <th class="w-1/12 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="plan-flow-table-body" class="bg-white divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="task-detail-pane" class="w-full md:w-1/3 flex-shrink-0 bg-white border-l border-gray-200 flex flex-col custom-scrollbar overflow-y-auto shadow-lg">
            <div class="p-6 border-b border-gray-200 sticky top-0 bg-gray-50 z-10">
                <h2 class="text-xl font-bold text-gray-800">计划项详情</h2>
            </div>
            <div id="task-detail-content" class="flex-grow p-4 bg-white">
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            </div>
        </div>
    </div>

    <div id="activation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">激活可选任务</h3>

            <div class="space-y-4">
                <p id="modal-task-name" class="text-lg font-semibold text-indigo-600"></p>
                <input type="hidden" id="modal-phase-id">
                <input type="hidden" id="modal-dtask-id">

                <div>
                    <label for="modal-owner" class="block text-sm font-medium text-gray-700">指定负责人</label>
                    <input type="text" id="modal-owner" value="预算员/部门负责人" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-due-date" class="block text-sm font-medium text-gray-700">截止日期 (可选)</label>
                    <input type="date" id="modal-due-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="modal-comment" class="block text-sm font-medium text-gray-700">启动备注</label>
                    <textarea id="modal-comment" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="请说明激活此可选任务的原因..."></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">
                    取消
                </button>
                <button onclick="confirmActivation()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">
                    确认激活并分配
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- 新增映射表：将看板节点ID映射到待办收件箱中的任务ID ---
        const kanbanToInboxMap = {
            // Kanban ID -> Inbox Task ID
            203: 7, // '资本支出计划提报'
            204: 8, // '收入预测模型核对'
            301: 1, // '财务初审与汇总'
        };
        function openTaskInInbox(kanbanNodeId) {
            const inboxTaskId = kanbanToInboxMap[kanbanNodeId];
            if (inboxTaskId) {
                showMessage(`正在新标签页中打开待办任务中心，任务 ID: ${inboxTaskId}，并筛选流程为【财务预算 V2】`, 'info');

                // 关键修改：新增 processFilter 参数，并对中文进行编码
                const processName = '财务预算 V2';
                const url = `taskinbox/index.html?taskId=${inboxTaskId}&processFilter=${encodeURIComponent(processName)}`;

                // 使用 window.open() 在新标签页打开
                window.open(url, '_blank');

            } else {
                showMessage(`节点 ID ${kanbanNodeId} 暂无对应待办任务 (Inbox Task ID)。`, 'warning');
            }
        }
        // -----------------------------------------------------------------

        // Mock data for the budget plan flow (tree structure)
        const budgetPlanTree = [
            { id: 100, name: '项目准备与启动', type: 'Phase', progress: 100, owner: '项目经理', children: [
                { id: 101, name: '预算目标设定', type: 'Milestone', progress: 100, startDate: '2025-11-01', endDate: '2025-11-05', owner: '高管层', status: 'Completed' },
                { id: 102, name: '预算模型与工具准备', type: 'Task', progress: 100, startDate: '2025-11-01', endDate: '2025-11-10', owner: 'IT/财务部', status: 'Completed' }
            ]},
            { id: 200, name: '部门草案编制', type: 'Phase', progress: 75, owner: '财务部',
                // CMMN: Discretionary Tasks - Can be activated anytime during this phase
                discretionaryTasks: [
                    { id: 901, name: '进行专项成本分析', owner: '预算员', type: 'DiscretionaryTask', status: 'Available' },
                    { id: 902, name: '召开跨部门沟通会议', owner: '部门负责人', type: 'DiscretionaryTask', status: 'Available' }
                ],
                // 阶段内的任务和里程碑 (Milestone 205 是新增的，作为阶段出口检查点)
                children: [
                    { id: 201, name: '下发编制模板', type: 'Task', progress: 100, startDate: '2025-11-11', endDate: '2025-11-12', owner: '财务部', status: 'Completed' },
                    { id: 202, name: '各部门费用预算提报', type: 'Task', progress: 100, startDate: '2025-11-13', endDate: '2025-11-20', owner: '各部门负责人', status: 'Completed' },
                    { id: 203, name: '资本支出计划提报', type: 'Task', progress: 50, startDate: '2025-11-21', endDate: '2025-11-28', owner: '技术/运营部', status: 'Pending', dependencies: [202] },
                    { id: 204, name: '收入预测模型核对', type: 'Task', progress: 0, startDate: '2025-11-29', endDate: '2025-12-05', owner: '市场部', status: 'Pending', dependencies: [202] },
                    { id: 205, name: '所有部门草案已提报 (里程碑)', type: 'Milestone', progress: 0, startDate: '—', endDate: '—', owner: '系统检查', status: 'Blocked', dependencies: [203, 204] } // <-- 新增阶段检查里程碑
                ]
            },
            { id: 300, name: '复核与审批', type: 'Phase', progress: 10, owner: '财务总监', children: [
                // Task 301 依赖于 Stage 200 的出口里程碑 205
                { id: 301, name: '财务初审与汇总', type: 'Task', progress: 10, startDate: '2025-12-06', endDate: '2025-12-15', owner: '财务部', status: 'Pending', dependencies: [205] },
                { id: 302, name: '高管委员会审批通过', type: 'Milestone', progress: 0, startDate: '2025-12-16', endDate: '2025-12-20', owner: '高管委', status: 'Blocked', dependencies: [301] }
            ]},
            // 移除了原有的 350 修订循环阶段，采用 Stage 200 重开逻辑
            { id: 400, name: '预算发布与锁定', type: 'Phase', progress: 0, owner: '行政管理', children: [
                { id: 401, name: '系统录入与锁定 (自动)', type: 'SystemTask', progress: 0, startDate: '2025-12-21', endDate: '2025-12-25', owner: '系统/IT部', status: 'Blocked', dependencies: [302] }
            ]}
        ];

        let activeNodeId = 200; // Initial selected node
        let expandedNodes = new Set([100, 200, 300, 400]); // Initially expanded phases
        let allNodesMap = new Map(); // Flat map for quick lookup

        // --- NEW: Tracking historical instances for stages ---
        let stageInstances = {
            // Stage ID: [ { instance: 1, status: 'Completed', timestamp: Date.now(), comment: 'Initial run', tasksCompleted: [...] } ]
            200: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }],
            300: [{ instance: 1, status: 'Pending', timestamp: Date.now(), comment: 'Initial run' }]
        };
        let currentInstanceId = 1;

        /**
         * Custom Message Box for Non-Alert Notifications
         */
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';
            if (type === 'warning') bgColor = 'bg-amber-500';

            box.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0 ${bgColor}`;
            box.innerHTML = message;

            // Animate in
            requestAnimationFrame(() => {
                box.classList.remove('translate-x-full', 'opacity-0');
                box.classList.add('translate-x-0', 'opacity-100');
            });

            // Animate out after 4 seconds
            setTimeout(() => {
                box.classList.remove('translate-x-0', 'opacity-100');
                box.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        }

        // --- Modal Functions (unchanged, related to Discretionary Tasks) ---

        function showActivateModal(phaseId, dTaskId, taskName) {
            const modal = document.getElementById('activation-modal');
            const phaseNode = allNodesMap.get(phaseId);
            const dTask = phaseNode.discretionaryTasks.find(t => t.id === dTaskId);
            document.getElementById('modal-title').textContent = `激活可选任务：${taskName}`;
            document.getElementById('modal-task-name').textContent = taskName;
            document.getElementById('modal-phase-id').value = phaseId;
            document.getElementById('modal-dtask-id').value = dTaskId;
            document.getElementById('modal-owner').value = dTask ? dTask.owner : '待分配';
            document.getElementById('modal-due-date').value = '';
            document.getElementById('modal-comment').value = '';
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('activation-modal').classList.add('hidden');
        }

        function confirmActivation() {
            const phaseId = parseInt(document.getElementById('modal-phase-id').value);
            const dTaskId = parseInt(document.getElementById('modal-dtask-id').value);
            const newOwner = document.getElementById('modal-owner').value;
            const dueDate = document.getElementById('modal-due-date').value;
            const comment = document.getElementById('modal-comment').value;
            closeModal();
            const phaseNode = allNodesMap.get(phaseId);
            if (!phaseNode || !phaseNode.discretionaryTasks) {
                showMessage('错误: 无法找到所属阶段', 'error');
                return;
            }
            const dTask = phaseNode.discretionaryTasks.find(t => t.id === dTaskId);
            if (dTask) {
                dTask.status = 'Pending';
                dTask.owner = newOwner;
                dTask.endDate = dueDate || '未指定';
                dTask.comment = comment;
                renderTaskDetail(phaseNode, getEffectiveStatus(phaseNode));
                showMessage(`可选任务 [${dTask.name}] 已成功激活并分配给 ${newOwner}。`, 'success');
            } else {
                showMessage('错误: 无法找到可选任务', 'error');
            }
        }
        // --- End Modal Functions ---

        /**
         * Recursively finds a node by ID in the tree structure.
         */
        function findNodeById(nodes, id) {
            for (const node of nodes) {
                if (node.id === id) {
                    return node;
                }
                if (node.children) {
                    const found = findNodeById(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        /**
         * Flattens the tree and maps all nodes by ID for fast lookup.
         */
        function flattenAndMapNodes(nodes, map = new Map()) {
            nodes.forEach(node => {
                map.set(node.id, node);
                if (node.children) {
                    flattenAndMapNodes(node.children, map);
                }
            });
            return map;
        }

        /**
         * Determines the effective status of a task/milestone, considering dependencies.
         */
        function getEffectiveStatus(node) {
            if (node.status === 'Completed' || node.status === 'AwaitingRevision') return node.status; // Keep AwaitingRevision for 301

            if (node.dependencies && node.dependencies.length > 0) {
                const isBlocked = node.dependencies.some(depId => {
                    const depNode = allNodesMap.get(depId);
                    // If the dependency node is missing or not completed, the current node is blocked
                    return !depNode || getEffectiveStatus(depNode) !== 'Completed';
                });

                if (isBlocked) {
                    return 'Blocked';
                }
            }
            // If the node is a Phase, determine its status based on children
            if (node.type === 'Phase' && node.children) {
                 const allCompleted = node.children.every(c => getEffectiveStatus(c) === 'Completed' || c.status === 'Completed');
                 const anyPending = node.children.some(c => getEffectiveStatus(c) === 'Pending' || c.status === 'Pending');

                 if(allCompleted) return 'Completed';
                 if(anyPending) return 'Pending';
                 // If all tasks are blocked or initial (Draft/Available)
                 return 'Draft';
            }

            // Use the node's stored status if not completed and not blocked by dependencies
            return node.status;
        }

        /**
         * Toggles the expansion/collapse state of a Phase node.
         */
        function toggleExpansion(id) {
            if (expandedNodes.has(id)) {
                expandedNodes.delete(id);
            } else {
                expandedNodes.add(id);
            }
            renderTreeTable();
            selectPlanNode(activeNodeId, false); // Keep the current selection highlighted
        }

        /**
         * Renders the action menu (Kebab Menu or system action button)
         */
        function renderActionMenu(node, effectiveStatus) {
            if (node.type === 'Phase') return '—';

            const isSystemTask = node.type === 'SystemTask';
            const isDisabled = effectiveStatus === 'Completed' || effectiveStatus === 'Blocked';

            // Script Task: If not completed or blocked, provide 'Trigger Run' button
            if (isSystemTask && !isDisabled) {
                 return `
                    <button class="text-blue-600 text-sm font-medium hover:underline p-1"
                        onclick="event.stopPropagation(); handleRowAction(${node.id}, 'TriggerSystem')">
                        触发运行
                    </button>
                 `;
            } else if (isSystemTask && isDisabled) {
                 return '—'; // System tasks don't need Kebab menu when completed/blocked
            }


            // Kebab Menu for Manual Tasks/Milestones
            return `
                <div class="relative inline-block text-left">
                    <button type="button"
                        onclick="event.stopPropagation(); toggleDropdown(event, ${node.id})"
                        class="p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${isDisabled ? 'disabled' : ''}
                        aria-expanded="false" aria-haspopup="true">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                    </button>

                    <div id="dropdown-${node.id}"
                        class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                            <a href="#" onclick="event.preventDefault(); handleRowAction(${node.id}, 'OpenForm')" class="flex items-center px-4 py-2 text-sm text-indigo-600 hover:bg-gray-100 hover:text-indigo-700" role="menuitem">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                填写表单/查看数据
                            </a>
                            <a href="#" onclick="event.preventDefault(); handleRowAction(${node.id}, 'Assign')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                分派任务
                            </a>
                            <a href="#" onclick="event.preventDefault(); handleRowAction(${node.id}, 'Comment')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.533 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                添加备注
                            </a>
                            <a href="#" onclick="event.preventDefault(); handleRowAction(${node.id}, 'ViewLog')" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M15 12h.01"></path></svg>
                                查看流程历史
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Closes all dropdown menus.
         */
        function closeAllDropdowns() {
             document.querySelectorAll('.origin-top-right').forEach(d => d.classList.add('hidden'));
        }

        /**
         * Toggles a specific dropdown menu.
         */
        function toggleDropdown(event, id) {
            closeAllDropdowns();
            const dropdown = document.getElementById(`dropdown-${id}`);
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }

        /**
         * Recursively renders the tree table rows.
         */
        function renderTreeTableRows(nodes, level = 0, parentId = null) {
            let html = '';
            nodes.forEach(node => {
                const effectiveStatus = getEffectiveStatus(node);
                const isPhase = node.type === 'Phase';
                const isMilestone = node.type === 'Milestone';
                const hasChildren = node.children && node.children.length > 0;
                const isExpanded = expandedNodes.has(node.id);
                const isBlocked = effectiveStatus === 'Blocked';
                const isCompleted = effectiveStatus === 'Completed';
                const isAwaitingRevision = effectiveStatus === 'AwaitingRevision'; // NEW: Special status for 301
                const isDiscretionary = node.discretionary === true;

                // Don't render children if parent phase is collapsed
                if (parentId && !expandedNodes.has(parentId)) return;

                // Determine row class
                let rowClass = `cursor-pointer hover:bg-gray-50 transition duration-150`;
                if (isBlocked) {
                    rowClass = 'row-blocked cursor-not-allowed';
                }
                if (isAwaitingRevision) { // NEW: Highlight task 301 when waiting for revision
                    rowClass += ' row-revision';
                }

                // Inline style for indentation (1rem per level)
                const paddingLeft = isPhase ? `${0.75 + level * 1.5}rem` : `${0.75 + level * 1.5}rem`;

                // Status Tag
                const getStatusTag = (status) => {
                    let color = 'gray';
                    let text = '未开始/草稿';
                    if (status === 'Completed') { color = 'emerald'; text = '已完成'; }
                    if (status === 'Pending' || status === 'Draft') { color = 'indigo'; text = '进行中/待处理'; }
                    if (status === 'Blocked') { color = 'red'; text = '被阻止'; }
                    if (status === 'Available') { color = 'blue'; text = '可选/待激活'; }
                    if (status === 'AwaitingRevision') { color = 'amber'; text = '驳回 (待修订)'; } // NEW status tag

                    // For Phase 200, show current instance number
                    if (node.id === 200 && status !== 'Completed') {
                        const currentInstance = stageInstances[200] ? stageInstances[200].length : 1;
                        text = `进行中 (V${currentInstance})`;
                        color = 'indigo';
                    }

                    return `<span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700">${text}</span>`;
                };

                // Dependencies Text
                const dependenciesText = node.dependencies ? node.dependencies.map(depId => {
                    const depNode = allNodesMap.get(depId);
                    return depNode ? depNode.name : `ID:${depId}`;
                }).join('; ') : '—';

                // Progress bar colors
                const progressColor = isCompleted ? 'text-emerald-600' : isBlocked ? 'text-gray-400' : (node.type === 'SystemTask' ? 'text-blue-600' : (isAwaitingRevision ? 'text-amber-600' : 'text-indigo-600'));
                const progressBg = isCompleted ? 'bg-emerald-500' : isBlocked ? 'bg-gray-300' : (node.type === 'SystemTask' ? 'bg-blue-500' : (isAwaitingRevision ? 'bg-amber-500' : 'bg-indigo-500'));

                // Expansion/Collapse icon and Type icon
                let expandIcon = '';
                let typeIcon = '';
                if (hasChildren) {
                    // Phase icons
                    expandIcon = `<svg onclick="event.stopPropagation(); toggleExpansion(${node.id})" class="w-4 h-4 text-gray-500 hover:text-indigo-600 transition cursor-pointer inline-block mr-2 transform ${isExpanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                    typeIcon = `<span class="text-xs mr-1 text-gray-500">&#9679;</span>`;
                } else {
                    // Leaf nodes
                    expandIcon = `<span class="inline-block w-6 h-4 mr-2"></span>`;

                    if (isMilestone) {
                        // Milestones get a Flag icon
                        typeIcon = `<svg class="w-4 h-4 mr-1 text-purple-500 inline-block align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H10.5l-1-1H5a2 2 0 00-2 2v4zm9-12h.01"></path></svg>`;
                    } else {
                        // Tasks and SystemTasks get a Dot icon
                        typeIcon = `<span class="text-xs mr-1 text-gray-400">&#9679;</span>`;
                    }
                }

                html += `
                    <tr id="node-row-${node.id}" class="${rowClass}" onclick="selectPlanNode(${node.id})">
                        <td class="py-3 text-sm font-medium text-gray-900" style="padding-left: ${paddingLeft};">
                            <div class="flex items-center">
                                ${expandIcon}
                                ${isPhase ? `
                                    <span class="font-bold text-indigo-600">${node.name}</span>
                                    ${node.id === 200 ? `<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-700 font-semibold">V${stageInstances[200].length}</span>` : ''}
                                ` : `
                                    ${typeIcon}
                                    ${node.name}
                                    ${isDiscretionary ? '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700 font-semibold">可选任务</span>' : ''}
                                `}
                                ${isPhase && node.repetition ? '<span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700 font-semibold">CMMN Looped</span>' : ''}
                            </div>
                        </td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap ${isBlocked ? 'text-gray-400' : 'text-gray-700'}">${node.owner || '—'}</td>
                        <td class="py-3 px-4 text-sm w-32">
                            <div class="flex items-center space-x-2">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    ${isMilestone ? `
                                        <div class="h-2.5 rounded-full ${isCompleted ? 'bg-purple-500' : 'bg-gray-200'}" style="width: ${isCompleted ? 100 : 0}%"></div>
                                    ` : `
                                        <div class="h-2.5 rounded-full ${progressBg}" style="width: ${isBlocked ? 0 : node.progress}%"></div>
                                    `}
                                </div>
                                <span class="text-xs font-semibold ${isMilestone ? (isCompleted ? 'text-purple-600' : 'text-gray-500') : progressColor}">
                                    ${isBlocked ? 'Blocked' : (isMilestone ? (isCompleted ? 'Done' : 'Check') : node.progress + '%')}
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap ${isBlocked ? 'text-gray-400' : 'text-gray-600'}">${node.endDate || '—'}</td>
                        <td class="py-3 px-4 text-xs truncate max-w-xs ${isBlocked ? 'text-gray-400' : 'text-gray-500'}">${dependenciesText}</td>
                        <td class="py-3 px-2 text-center">
                            ${renderActionMenu(node, effectiveStatus)}
                        </td>
                    </tr>
                `;
                // Recursively render children
                if (hasChildren && isExpanded) {
                    html += renderTreeTableRows(node.children, level + 1, node.id);
                }
            });
            return html;
        }

        /**
         * Renders the main tree table.
         */
        function renderTreeTable() {
            const tableBody = document.getElementById('plan-flow-table-body');
            // Update node map before rendering
            allNodesMap = flattenAndMapNodes(budgetPlanTree);
            if (tableBody) {
                tableBody.innerHTML = renderTreeTableRows(budgetPlanTree);
            }
            closeAllDropdowns(); // Close dropdowns after re-render
        }

        /**
         * Selects a table row, highlights it, and displays its details.
         */
        function selectPlanNode(id, shouldToggleExpansion = true) {
            // 1. Handle highlight styles
            const oldRow = document.getElementById(`node-row-${activeNodeId}`);
            if (oldRow) {
                oldRow.classList.remove('row-active');
            }
            activeNodeId = id;
            const newRow = document.getElementById(`node-row-${activeNodeId}`);
            if (newRow) {
                newRow.classList.add('row-active');
            }

            // 2. Find node and render details
            const node = allNodesMap.get(id);
            if (node) {
                renderTaskDetail(node, getEffectiveStatus(node));
                // For Phases, expand/collapse if clicked (default behavior)
                if (node.type === 'Phase' && shouldToggleExpansion) {
                    toggleExpansion(id);
                }
            }
            closeAllDropdowns();
        }

        /**
         * Renders the right detail pane content for the selected node.
         */
        function renderTaskDetail(node, effectiveStatus) {
            const detailContent = document.getElementById('task-detail-content');
            const isPhase = node.type === 'Phase';
            const isBlocked = effectiveStatus === 'Blocked';
            const isCompleted = effectiveStatus === 'Completed';

            const getStatusTag = (status) => {
                let color = 'gray';
                let text = '未开始/草稿';
                if (status === 'Completed') { color = 'emerald'; text = '已完成'; }
                if (status === 'Pending' || status === 'Draft') { color = 'indigo'; text = '进行中/待处理'; }
                if (status === 'Blocked') { color = 'red'; text = '被阻止'; }
                if (status === 'Available') { color = 'blue'; text = '可选/待激活'; }
                if (status === 'AwaitingRevision') { color = 'amber'; text = '驳回 (待修订)'; }

                // For Phase 200, show current instance number
                if (node.id === 200 && status !== 'Completed') {
                    const currentInstance = stageInstances[200] ? stageInstances[200].length : 1;
                    text = `进行中 (V${currentInstance})`;
                    color = 'indigo';
                }

                return `<span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700">${text}</span>`;
            };

            // Dependencies Text (with link to dependency node)
            const dependenciesHtml = node.dependencies ? node.dependencies.map(depId => {
                const depNode = allNodesMap.get(depId);
                const depStatus = depNode ? getEffectiveStatus(depNode) : 'Unknown';
                const statusColor = depStatus === 'Completed' ? 'text-emerald-600' : (depStatus === 'Blocked' ? 'text-red-500' : 'text-indigo-600');
                const statusText = depStatus === 'Completed' ? '已达成' : (depStatus === 'Blocked' ? '阻止中' : '未达成');
                return `<p class="flex justify-between items-center text-sm">
                    <span class="cursor-pointer hover:underline" onclick="selectPlanNode(${depId})">${depNode ? depNode.name : `ID:${depId}`}</span>
                    <span class="${statusColor} font-semibold">${statusText}</span>
                </p>`;
            }).join('') : '<p class="text-gray-500">无</p>';

            let detailHtml = '';
            if (isPhase) {
                // Phase Detail - Summary information
                const totalTasks = node.children ? node.children.length : 0;
                const completedTasks = node.children ? node.children.filter(t => getEffectiveStatus(t) === 'Completed').length : 0;

                let completionProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                if(isCompleted) completionProgress = 100;

                // History rendering for specific stages (like 200)
                const historyHtml = node.id === 200 && stageInstances[200] ? stageInstances[200].map(item => {
                    const date = new Date(item.timestamp).toLocaleDateString("zh-CN");
                    const time = new Date(item.timestamp).toLocaleTimeString("zh-CN");
                    const color = item.status.includes('Rejected') ? 'text-red-600' : item.status.includes('Completed') ? 'text-emerald-600' : 'text-indigo-600';
                    const icon = item.status.includes('Rejected') ? 'M6 18L18 6M6 6l12 12' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z';
                    return `
                        <div class="flex items-start justify-between text-sm py-2 border-b border-gray-100 last:border-b-0">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 ${color}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"></path></svg>
                                <div>
                                    <span class="font-semibold text-gray-800">版本 V${item.instance}</span>
                                    <span class="text-xs text-gray-500 ml-2">(${item.status})</span>
                                    <p class="text-xs text-gray-500">${item.comment}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400 whitespace-nowrap">${date} ${time}</span>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500 text-sm">无历史版本。</p>';


                detailHtml = `
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-indigo-600 mb-2">${node.name}</h3>
                        <div class="flex items-center space-x-3 mb-6">
                            ${getStatusTag(effectiveStatus)}
                            <span class="text-sm text-gray-500">阶段 (Phase)</span>
                        </div>


                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
                            <h4 class="font-semibold text-gray-700 mb-2">状态摘要</h4>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">任务完成度:</span>
                                <span class="text-sm font-semibold text-gray-800">${completedTasks} / ${totalTasks} (${completionProgress}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                <div class="h-2.5 rounded-full bg-indigo-500" style="width: ${completionProgress}%"></div>
                            </div>
                        </div>

                        <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">阶段实例历史 (V${stageInstances[node.id] ? stageInstances[node.id].length : 1})</h4>
                        <div class="bg-white border rounded-lg p-3 max-h-48 overflow-y-auto">
                            ${historyHtml}
                        </div>

                        <h4 class="font-semibold text-gray-700 mb-3 border-t pt-4 mt-4">可选/自由任务 (Discretionary Tasks)</h4>
                        <div class="space-y-3">
                            ${node.discretionaryTasks && node.discretionaryTasks.length > 0 ?
                                node.discretionaryTasks.map(dTask => {
                                    const isAvailable = dTask.status === 'Available';
                                    const isPending = dTask.status === 'Pending';
                                    const isCompletedTask = dTask.status === 'Completed';

                                    let buttonDisabled = '';
                                    let buttonText = '激活';
                                    let buttonClass = 'bg-green-600 hover:bg-green-700 text-white';
                                    let actionHandler = `showActivateModal(${node.id}, ${dTask.id}, '${dTask.name}')`;
                                    let statusDetail = '';

                                    if (isPending) {
                                        buttonDisabled = 'disabled';
                                        buttonText = '正在处理中';
                                        buttonClass = 'bg-indigo-300 text-indigo-800 cursor-not-allowed';
                                        statusDetail = `<span class="text-xs text-gray-600 ml-2">(${dTask.owner} / 截止: ${dTask.endDate || '未指定'})</span>`;
                                    } else if (isCompletedTask) {
                                        buttonDisabled = 'disabled';
                                        buttonText = '已完成';
                                        buttonClass = 'bg-emerald-300 text-emerald-800 cursor-not-allowed';
                                    }

                                    return `
                                        <div class="flex justify-between items-center p-3 bg-white border ${isPending ? 'border-indigo-400' : isCompletedTask ? 'border-emerald-400' : 'border-gray-200'} rounded-lg shadow-sm">
                                            <div>
                                                <span class="text-gray-800">${dTask.name}</span>
                                                ${statusDetail}
                                            </div>
                                            <button class="text-sm ${buttonClass} py-1 px-3 rounded-md transition duration-150"
                                                    onclick="${isAvailable ? actionHandler : 'event.stopPropagation();'}" ${buttonDisabled}>
                                                ${buttonText}
                                            </button>
                                        </div>
                                    `;
                                }).join('')
                            : `<p class="text-gray-500 text-sm">此阶段没有可选任务。</p>`}
                        </div>

                    </div>
                `;
            } else {
                // Task/Milestone/System Task Detail
                const typeText = node.type === 'Milestone' ? '里程碑 (CMMN 检查点)' : node.type === 'SystemTask' ? '脚本任务 (系统自动执行)' : '任务 (CMMN 工作项)';
                const hasInboxLink = kanbanToInboxMap[node.id];

                detailHtml = `
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${node.name}</h3>
                        <div class="flex items-center space-x-3 mb-6">
                            ${getStatusTag(effectiveStatus)}
                            <span class="text-sm text-gray-500">${typeText}</span>
                        </div>
                        <div class="space-y-4 mb-8">
                            ${isBlocked ? `
                                <div class="p-3 bg-red-100 border border-red-300 rounded-lg text-red-800 font-medium">
                                    <p class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        此任务当前处于【被阻止】状态。请先完成前置依赖项。
                                    </p>
                                </div>
                            ` : ''}
                            ${effectiveStatus === 'AwaitingRevision' ? `
                                <div class="p-3 bg-amber-100 border border-amber-300 rounded-lg text-amber-800 font-medium">
                                    <p class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        此任务处于【驳回】状态，等待前序阶段 (V${stageInstances[200].length}) 重新提交流程。
                                    </p>
                                </div>
                            ` : ''}
                            <p class="text-gray-700"><strong>责任人:</strong> ${node.owner}</p>
                            <p class="text-gray-700"><strong>计划时间:</strong> ${node.startDate} - ${node.endDate}</p>
                            <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600 font-medium mb-2">前置依赖项:</p>
                                ${dependenciesHtml}
                            </div>
                        </div>

                        <div class="mt-8 pt-4 border-t border-gray-200">
                            ${isCompleted ? `
                                <p class="text-lg font-semibold text-emerald-600 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    任务已完成
                                </p>
                            ` : isBlocked || effectiveStatus === 'AwaitingRevision' ? `
                                <button class="bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-md cursor-not-allowed" disabled>
                                    ${isBlocked ? '任务被阻止 (依赖未完成)' : '等待前序修订完成'}
                                </button>
                            ` : node.type === 'SystemTask' ? `
                                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150" onclick="handleTaskAction(${node.id}, 'SystemExecute')">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    模拟系统执行完成 (Script Task)
                                </button>
                                <span class="text-sm text-gray-500 ml-4">系统任务通常在条件满足后自动触发，无需人工干预。</span>
                            ` : `
                                ${hasInboxLink ? `
                                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 mr-2"
                                            onclick="openTaskInInbox(${node.id})">
                                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-17 4v10a2 2 0 002 2h12a2 2 0 002-2v-10"></path></svg>
                                        处理待办任务 (Inbox ID: ${hasInboxLink})
                                    </button>
                                ` : ''}

                                <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 mr-2" onclick="handleTaskAction(${node.id}, 'Complete')">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    ${node.type === 'Milestone' ? '达成里程碑/完成检查' : '提交流程/完成'}
                                </button>
                                ${node.id === 301 ? `
                                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-150" onclick="handleTaskAction(${node.id}, 'Reject')">
                                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        退回修订 (Reject & Re-open Stage)
                                    </button>
                                `: ''}
                            `}
                        </div>
                    </div>
                `;
            }

            detailContent.innerHTML = detailHtml;
            // Scroll to top of detail panel
            const detailPane = document.getElementById('task-detail-pane');
            if (detailPane) {
                detailPane.scrollTop = 0;
            }
        }

        /**
         * Simulates task actions from the row-level Kebab menu.
         */
        function handleRowAction(taskId, actionType) {
            const node = findNodeById(budgetPlanTree, taskId);
            if (!node) return;

            let actionText = '';
            switch (actionType) {
                case 'TriggerSystem':
                    handleTaskAction(taskId, 'SystemExecute');
                    return;
                case 'OpenForm':
                    const inboxId = kanbanToInboxMap[taskId];
                    if (inboxId) {
                        openTaskInInbox(taskId);
                        return;
                    }
                    actionText = node.type === 'Milestone' ? '查看检查点数据' : '进入表单界面';
                    break;
                case 'Assign':
                    actionText = '重新分派责任人';
                    break;
                case 'Comment':
                    actionText = '打开评论区';
                    break;
                case 'ViewLog':
                    actionText = '查看流程历史日志';
                    break;
                default:
                    actionText = '执行未知操作';
            }
            showMessage(`正在模拟对 [${node.name}] 执行：${actionText}`, 'info');

            // Close all dropdown menus
            document.querySelectorAll('.origin-top-right').forEach(d => d.classList.add('hidden'));
        }

        /**
         * Simulates task completion/rejection.
         */
        function handleTaskAction(taskId, action) {
            const node = allNodesMap.get(taskId);
            if (!node) return;

            // 1. Completion Logic
            if (action === 'Complete' || action === 'SystemExecute') {
                // If 301 is completed, reset its status from AwaitingRevision if necessary
                if(taskId === 301 && node.status === 'AwaitingRevision') {
                    node.status = 'Pending';
                }

                node.progress = 100;
                node.status = 'Completed';
                activeNodeId = null;

                // Check and unlock subsequent dependent tasks
                let unlockedCount = 0;
                allNodesMap.forEach(dependedNode => {
                    if (dependedNode.dependencies && dependedNode.dependencies.includes(taskId)) {
                        const isNowReady = dependedNode.dependencies.every(depId => {
                            const depNode = allNodesMap.get(depId);
                            return depId === taskId || getEffectiveStatus(depNode) === 'Completed';
                        });
                        if (isNowReady && getEffectiveStatus(dependedNode) === 'Blocked') {
                            dependedNode.status = 'Pending';
                            dependedNode.progress = 0;
                            unlockedCount++;
                        }
                    }
                });

                let message = '';
                if (action === 'SystemExecute') {
                    message = `系统任务 [${node.name}] 模拟运行完成，预算数据已锁定。`;
                } else if (node.type === 'Milestone') {
                    message = `里程碑 [${node.name}] 已达成！成功激活 ${unlockedCount} 个后续计划项。`;
                } else {
                    message = `任务 [${node.name}] 已标记为 [已完成]。`;
                }
                showMessage(message, 'success');

            // 2. Rejection Logic (New logic for re-opening Stage 200)
            } else if (action === 'Reject' && taskId === 301) {

                const STAGE_ID_TO_RESET = 200;
                // Tasks/Milestones that must be redone within Stage 200
                const STAGE_RESET_NODES = [203, 204, 205];

                // 2.1. Update History Log
                currentInstanceId++;
                const stageToReset = allNodesMap.get(STAGE_ID_TO_RESET);

                // Find the current instance log to mark its final status
                const lastInstance = stageInstances[STAGE_ID_TO_RESET].slice(-1)[0];
                if(lastInstance) {
                    lastInstance.status = 'Completed (Rejected)';
                }

                // Add new instance log
                stageInstances[STAGE_ID_TO_RESET].push({
                    instance: currentInstanceId,
                    status: 'Pending',
                    timestamp: Date.now(),
                    comment: `驳回，需要重新提交流程 (V${currentInstanceId})`,
                    tasksReset: STAGE_RESET_NODES.map(id => allNodesMap.get(id).name)
                });

                // 2.2. Reset Tasks and Milestones within Stage 200
                STAGE_RESET_NODES.forEach(id => {
                    const resetNode = allNodesMap.get(id);
                    if (resetNode) {
                        resetNode.status = 'Pending';
                        resetNode.progress = 0;
                    }
                });

                // 2.3. Update the Rejecting Task (301)
                node.status = 'AwaitingRevision'; // Set 301 to Awaiting Revision
                node.progress = 0;

                // 2.4. Update the Stage (200)
                stageToReset.status = 'Pending'; // Set Phase 200 to Pending

                showMessage(`预算初审未通过，【${stageToReset.name}】阶段已重新打开 (V${currentInstanceId})。请检查表格中被重置的任务。`, 'warning');
            } else if (action === 'Reject') {
                showMessage(`任务 [${node.name}] 模拟被拒绝/退回，进入上一节点...`, 'warning');
            }

            // Re-render the table and details
            renderTreeTable();
            // Show initial message in detail pane after completion
            const detailContent = document.getElementById('task-detail-content');
            detailContent.innerHTML = `
                <div class="p-10 text-center text-gray-500">
                    <svg class="w-10 h-10 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p>请从左侧表格中选择一个计划项查看详情。</p>
                </div>
            `;
        }


        // Initial loading logic
        document.addEventListener('DOMContentLoaded', () => {
            // First time map nodes
            allNodesMap = flattenAndMapNodes(budgetPlanTree);
            renderTreeTable();
            // Ensure the initially selected row is highlighted and details are shown
            selectPlanNode(activeNodeId, false);
        });
    </script>
</body>
</html>